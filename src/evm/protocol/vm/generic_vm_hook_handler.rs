use std::{any::Any, collections::HashMap, fmt::Debug, str::FromStr};

use alloy::{
    primitives::{keccak256, Address, Bytes as AlloyBytes, Signed, Uint, B256, U160, U256},
    sol,
    sol_types::SolValue,
};
use revm::{
    state::{AccountInfo, Bytecode},
    DatabaseRef,
};
use tycho_common::{dto::ProtocolStateDelta, Bytes};

use crate::{
    evm::{
        engine_db::{create_engine, engine_db_interface::EngineDatabaseInterface, SHARED_TYCHO_DB},
        protocol::{
            uniswap_v4::{
                hook_handler::{
                    AfterSwapParameters, AmountRanges, BeforeSwapDelta, BeforeSwapParameters,
                    HookError, HookHandler, SwapParams, WithGasEstimate,
                },
                hook_handler_creator::{HookCreationParams, HookHandlerCreator},
                state::UniswapV4State,
            },
            vm::{constants::MAX_BALANCE, tycho_simulation_contract::TychoSimulationContract},
        },
        simulation::SimulationEngine,
    },
    models::{Balances, Token},
    protocol::errors::{InvalidSnapshotError, SimulationError, TransitionError},
};

#[derive(Debug, Clone)]
struct GenericVMHookHandler<D: EngineDatabaseInterface + Clone + Debug>
where
    <D as DatabaseRef>::Error: Debug,
    <D as EngineDatabaseInterface>::Error: Debug,
{
    contract: TychoSimulationContract<D>,
    address: Address,
    pool_manager: Address,
}

impl<D: EngineDatabaseInterface + Clone + Debug> PartialEq for GenericVMHookHandler<D>
where
    <D as DatabaseRef>::Error: Debug,
    <D as EngineDatabaseInterface>::Error: Debug,
{
    fn eq(&self, _other: &Self) -> bool {
        todo!()
    }
}

impl<D: EngineDatabaseInterface + Clone + Debug> GenericVMHookHandler<D>
where
    <D as DatabaseRef>::Error: Debug,
    <D as EngineDatabaseInterface>::Error: Debug,
{
    pub fn new(
        address: Address,
        bytecode: Bytecode,
        engine: SimulationEngine<D>,
    ) -> Result<Self, SimulationError> {
        // Init pool manager
        let pool_manager = Address::from_str("0x000000000004444c5dc75cb358380d2e3de08a90")
            .expect("Invalid pool manager address");

        let pool_manager_bytecode = Bytecode::new_raw(AlloyBytes::from(
            "0x60a0806040526004361015610012575f80fd5b5f3560e01c908162fdd58e14612cd55750806301ffc9a714612c16578063095bcdb614612b6c5780630b0d9c0914612ae057806311da60b414612a85578063156e29f6146129d55780631e2eaeaf1461299b578063234266d7146126fc5780632d7713891461265157806335fd631a146125dd5780633dd45adb14612579578063426a8493146124f557806348c894911461226a5780635275965114612152578063558a72971461207b578063598af9e714611fe35780635a6bcfda1461144f5780636276cbbe14610f965780637e87ce7d14610e5957806380f0b44c14610d875780638161b87414610c315780638da5cb5b14610be157806397e8cd4e14610b7e5780639bf6645f14610b31578063a584119414610a66578063b6363cf2146109d5578063dbd035ff1461097f578063f02de3b21461092e578063f135baaa146108f4578063f2fde38b14610848578063f3cd914c146104ff578063f5298aca146103345763fe99049a14610186575f80fd5b346103305760807ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610330576101bd612d3f565b6101c5612d62565b90604435917f1b3d7edb2e9c0b0e7c525b20aaaef0f5940d2ed71663c7d39266ecafac72885961027973ffffffffffffffffffffffffffffffffffffffff80606435951693843314158061030d575b610287575b845f52600460205260405f20875f5260205260405f2061023a878254612fed565b90551693845f52600460205260405f20865f5260205260405f2061025f828254612ffa565b905560408051338152602081019290925290918291820190565b0390a4602060405160018152f35b845f52600560205260405f208233165f5260205260405f20875f5260205260405f2054867fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82036102da575b5050610219565b6102e391612fed565b855f52600560205260405f208333165f5260205260405f20885f5260205260405f20555f866102d3565b50845f52600360205260405f208233165f5260205260ff60405f20541615610214565b5f80fd5b346103305761034236612d85565b7fc090fc4683624cfc3884e9d8de5eca132f2d0ec062aff75d43c0465d5ceeab235c156104d7577f1b3d7edb2e9c0b0e7c525b20aaaef0f5940d2ed71663c7d39266ecafac7288596103ed73ffffffffffffffffffffffffffffffffffffffff805f9516956103bb6103b3866130aa565b3390896130f0565b169233841415806104a0575b6103f2575b8385526004602052604085208686526020526040852061025f828254612fed565b0390a4005b83855260056020526040852073ffffffffffffffffffffffffffffffffffffffff33168652602052604085208686526020526040852054817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203610459575b50506103cc565b61046291612fed565b84865260056020526040862073ffffffffffffffffffffffffffffffffffffffff331687526020526040862087875260205260408620558681610452565b5083855260036020526040852073ffffffffffffffffffffffffffffffffffffffff3316865260205260ff604086205416156103c7565b7f54e3ca0d000000000000000000000000000000000000000000000000000000005f5260045ffd5b34610330576101207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126103305761053836612e81565b60607fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff5c360112610330576040519061056f82612df6565b60a4358015158103610330578252602082019060c435825260e4359073ffffffffffffffffffffffffffffffffffffffff8216820361033057604084019182526101043567ffffffffffffffff8111610330576105d0903690600401612f4d565b9290937fc090fc4683624cfc3884e9d8de5eca132f2d0ec062aff75d43c0465d5ceeab235c156104d75761060261350f565b51156108205760a0822092835f52600660205260405f209061062382613576565b60808401958482828a8a5173ffffffffffffffffffffffffffffffffffffffff169361064e94613b44565b90949195606088015160020b908b511515905173ffffffffffffffffffffffffffffffffffffffff1691604051986106858a612e12565b895260208901526040880152606087015262ffffff166080860152885115155f149862ffffff6107a2986106db61078f9860209d6108005773ffffffffffffffffffffffffffffffffffffffff8b511695614959565b9492968291926107d3575b505073ffffffffffffffffffffffffffffffffffffffff845116938e6fffffffffffffffffffffffffffffffff60408301511691015160020b90604051958860801d600f0b875288600f0b60208801526040870152606086015260808501521660a08301527f40e9cecb9f5f1f1c5b9c97dec2917b7ee92e57ba5563708daca94dd84ad7112f60c03393a38673ffffffffffffffffffffffffffffffffffffffff8a5116613d81565b809491946107aa575b5050823391613652565b604051908152f35b73ffffffffffffffffffffffffffffffffffffffff6107cc9251169083613652565b8480610798565b73ffffffffffffffffffffffffffffffffffffffff165f5260018f5260405f209081540190558e806106e6565b73ffffffffffffffffffffffffffffffffffffffff8e8c01511695614959565b7fbe8b8507000000000000000000000000000000000000000000000000000000005f5260045ffd5b346103305760207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610330577fffffffffffffffffffffffff00000000000000000000000000000000000000006108a0612d3f565b73ffffffffffffffffffffffffffffffffffffffff5f54916108c58284163314613007565b1691829116175f55337f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e05f80a3005b346103305760207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610330576004355c5f5260205ff35b34610330575f7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261033057602073ffffffffffffffffffffffffffffffffffffffff60025416604051908152f35b346103305761098d36612f7b565b6040519160408360208152836020820152019160051b8301916020806040850193925b83355481520191019084838210156109cc5750602080916109b0565b60408186030190f35b346103305760407ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261033057610a0c612d3f565b73ffffffffffffffffffffffffffffffffffffffff610a29612d62565b91165f52600360205273ffffffffffffffffffffffffffffffffffffffff60405f2091165f52602052602060ff60405f2054166040519015158152f35b346103305760207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261033057610a9d612d3f565b73ffffffffffffffffffffffffffffffffffffffff81169081610ae15750505f7f27e098c505d44ec3574004bca052aabf76bd35004c182099d8c575fb238593b95d005b610aea90613a92565b907f27e098c505d44ec3574004bca052aabf76bd35004c182099d8c575fb238593b95d7f1e0745a7db1623981f0b2a5d4232364c00787266eb75ad546f190e6cebe9bd955d005b3461033057610b3f36612f7b565b6040519160408360208152836020820152019160051b8301916020806040850193925b83355c81520191019084838210156109cc575060208091610b62565b346103305760207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126103305773ffffffffffffffffffffffffffffffffffffffff610bca612d3f565b165f526001602052602060405f2054604051908152f35b34610330575f7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261033057602073ffffffffffffffffffffffffffffffffffffffff5f5416604051908152f35b346103305760607ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261033057610c68612d3f565b610c70612d62565b60443573ffffffffffffffffffffffffffffffffffffffff600254163303610d5f5773ffffffffffffffffffffffffffffffffffffffff821680151580610d1f575b610cf7576020936107a29280610cef5750815f526001855260405f20549384925b5f526001865260405f20610ce8848254612fed565b90556131f8565b938492610cd3565b7fc79e5948000000000000000000000000000000000000000000000000000000005f5260045ffd5b508073ffffffffffffffffffffffffffffffffffffffff7f27e098c505d44ec3574004bca052aabf76bd35004c182099d8c575fb238593b95c1614610cb2565b7f48f5c3ed000000000000000000000000000000000000000000000000000000005f5260045ffd5b346103305760407ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261033057610dbe612d3f565b7fc090fc4683624cfc3884e9d8de5eca132f2d0ec062aff75d43c0465d5ceeab235c156104d757335f90815273ffffffffffffffffffffffffffffffffffffffff8216602052604090205c610e146024356130aa565b9081600f0b03610e3157610e2f9133915f03600f0b906130f0565b005b7fbda73abf000000000000000000000000000000000000000000000000000000005f5260045ffd5b346103305760c07ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261033057610e9136612e81565b610e99612e6f565b9073ffffffffffffffffffffffffffffffffffffffff600254163303610d5f57623e900062fff0008316106103e9610fff8416101615610f6557602060a07fe9c42593e71f84403b84352cd168d693e2c9fcd1fdbcc3feb21d92b43e6696f9922092835f526006825260405f20610f0f81613576565b805479ffffff00000000000000000000000000000000000000000000008360b81b16907fffffffffffff000000ffffffffffffffffffffffffffffffffffffffffffffff1617905562ffffff60405191168152a2005b62ffffff827fa7abe2f7000000000000000000000000000000000000000000000000000000005f521660045260245ffd5b346103305760c07ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261033057610fce36612e81565b60a4359073ffffffffffffffffffffffffffffffffffffffff821680830361033057610ff861350f565b6060820191825160020b617fff81136114245750825160020b600181126113f9575073ffffffffffffffffffffffffffffffffffffffff815116602082019073ffffffffffffffffffffffffffffffffffffffff825116808210156113c2575050608082019073ffffffffffffffffffffffffffffffffffffffff82511690604084019161108c62ffffff845116826139b7565b1561139757506110a162ffffff835116613a75565b96835173ffffffffffffffffffffffffffffffffffffffff8116908133036112e0575b505060a0852090815f52600660205260405f2090815473ffffffffffffffffffffffffffffffffffffffff166112b8576020997fdd466e674ea557f56295e2d0218a125ea4b4f0f6f3307b95f85e6110838d6438927cffffff000000000000000000000000000000000000000000000000000061114260a0946145fc565b9260d01b168a76ffffff000000000000000000000000000000000000000084861b161717905562ffffff73ffffffffffffffffffffffffffffffffffffffff808a5116965116965116995160020b73ffffffffffffffffffffffffffffffffffffffff885116906040519b8c528c8c015260408b01528860608b015260020b98896080820152a45173ffffffffffffffffffffffffffffffffffffffff8116908133036111f4575b8585604051908152f35b61100016611203575b806111ea565b6112af9261128d604051937f6fe7e6eb0000000000000000000000000000000000000000000000000000000088860152336024860152604485019073ffffffffffffffffffffffffffffffffffffffff6080809282815116855282602082015116602086015262ffffff6040820151166040860152606081015160020b6060860152015116910152565b60e48301528361010483015261010482526112aa61012483612e2e565b613f25565b508280806111fd565b7f7983c051000000000000000000000000000000000000000000000000000000005f5260045ffd5b612000166112ef575b806110c4565b61139090604051907fdc98354e00000000000000000000000000000000000000000000000000000000602083015233602483015261137a604483018973ffffffffffffffffffffffffffffffffffffffff6080809282815116855282602082015116602086015262ffffff6040820151166040860152606081015160020b6060860152015116910152565b8860e483015260e482526112aa61010483612e2e565b50886112e9565b7fe65af6a0000000000000000000000000000000000000000000000000000000005f5260045260245ffd5b60449250604051917f6e6c983000000000000000000000000000000000000000000000000000000000835260048301526024820152fd5b7fe9e90588000000000000000000000000000000000000000000000000000000005f5260045260245ffd5b7fb70024f8000000000000000000000000000000000000000000000000000000005f5260045260245ffd5b34610330576101407ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126103305761148836612e81565b60807fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff5c36011261033057604051906114bf82612dda565b60a4358060020b810361033057825260c4358060020b810361033057602083015260e43560408301526101043560608301526101243567ffffffffffffffff811161033057611512903690600401612f4d565b90927fc090fc4683624cfc3884e9d8de5eca132f2d0ec062aff75d43c0465d5ceeab235c156104d75761154361350f565b60a0832093845f52600660205260405f20608052611562608051613576565b608084015173ffffffffffffffffffffffffffffffffffffffff811690813303611ede575b5050815160020b92602083015160020b916115a56040850151613785565b93606087015160020b9760608201516040519960c08b018b811067ffffffffffffffff821117611eb157604052338b528860208c01528660408c015287600f0b60608c015260808b015260a08a01525f9185881215611e7a577ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff276188812611e4e57620d89e88613611e22576040519261163c84612dda565b5f84525f60208501525f60408501525f606085015287600f0b611b25575b600460805101978960020b5f528860205260405f20988860020b5f5260205260405f206080515460a01c60020b8b81125f14611acf575060028060018c0154600184015490039b015491015490039b5b60a073ffffffffffffffffffffffffffffffffffffffff825116910151906040519160268301528960068301528b600383015281525f603a600c83012091816040820152816020820152525f5260066080510160205260405f20976fffffffffffffffffffffffffffffffff8954169982600f0b155f14611a72578a15611a4a5761176f61176960409f9b61184e9c6118609e5b60018301956117616002611755848a548503615703565b95019283548503615703565b9655556130aa565b916130aa565b6fffffffffffffffffffffffffffffffff169060801b179a8b965f84600f0b126119dc575b5082600f0b611898575b5050506117c46117b58560801d8360801d01613785565b9185600f0b90600f0b01613785565b6fffffffffffffffffffffffffffffffff169060801b1791815160020b90602083015160020b8c8401516060850151918e5194855260208501528d84015260608301527ff208f4912782fd25c7f114ca3723a2d5dd6f3bcc3ac8db5af63baa85f711d5ec60803393a38873ffffffffffffffffffffffffffffffffffffffff60808201511661385b565b8094919461186c575b50833391613652565b82519182526020820152f35b6118929073ffffffffffffffffffffffffffffffffffffffff6080840151169083613652565b85611857565b60805154929350909173ffffffffffffffffffffffffffffffffffffffff81169060a01c60020b828112156118fe575050906118f2926118e76118dd6118ed94614158565b91600f0b92614158565b90614527565b613785565b60801b5b8b808061179e565b92809193125f146119a95761193d9161192a6118ed6118ed9361192488600f0b91614158565b87614527565b9361193886600f0b92614158565b6144ca565b6fffffffffffffffffffffffffffffffff169060801b17906fffffffffffffffffffffffffffffffff61197c60036080510192600f0b8284541661456e565b167fffffffffffffffffffffffffffffffff000000000000000000000000000000008254161790556118f6565b906118ed9250926119bf6118dd6119c595614158565b906144ca565b6fffffffffffffffffffffffffffffffff166118f6565b808f9151611a1e575b01516119f2575b8e611794565b611a198260805160049160020b5f52016020525f6002604082208281558260018201550155565b6119ec565b611a458360805160049160020b5f52016020525f6002604082208281558260018201550155565b6119e5565b7faefeb924000000000000000000000000000000000000000000000000000000005f5260045ffd5b61176f61176960409f9b61184e9c6118609e6fffffffffffffffffffffffffffffffff611aa289600f0b8361456e565b167fffffffffffffffffffffffffffffffff0000000000000000000000000000000084541617835561173e565b9099908913611af55760028060018c0154600184015490039b015491015490039b6116aa565b9860026001608051015460018c01549003600183015490039a81806080510154910154900391015490039b6116aa565b6004608051018960020b5f5280602052898960405f20611b7e81546fffffffffffffffffffffffffffffffff611b6181831695600f0b8661456e565b16931594858515141595611dee575b508d600f0b9060801d613d3a565b60801b82179055602087015285528760020b5f5260205260405f208054906fffffffffffffffffffffffffffffffff8216611bbc8b600f0b8261456e565b901592836fffffffffffffffffffffffffffffffff831615141593611dc1575b8b600f0b9060801d600f0b03916f7fffffffffffffffffffffffffffffff83137fffffffffffffffffffffffffffffffff80000000000000000000000000000000841217611d9457826fffffffffffffffffffffffffffffffff935060801b83831617905516606086015260408501525f88600f0b1215611ca1575b8351611c85575b60408401511561165a57611c8060808c015160020b8860056080510161410c565b61165a565b611c9c60808c015160020b8a60056080510161410c565b611c5f565b60808b015160020b6fffffffffffffffffffffffffffffffff600181602088015116925f817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff276180712817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff27618050390620d89e8050301810416809111611d68576fffffffffffffffffffffffffffffffff6060860151161115611c5857867fb8e3c385000000000000000000000000000000000000000000000000000000005f5260045260245ffd5b897fb8e3c385000000000000000000000000000000000000000000000000000000005f5260045260245ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b6080515460a01c60020b8b13611bdc57600160805101546001840155600260805101546002840155611bdc565b6080515460a01c60020b1215611e05575b8e611b70565b600160805101546001840155600260805101546002840155611dff565b857f1ad777f8000000000000000000000000000000000000000000000000000000005f5260045260245ffd5b877fd5e2f7ab000000000000000000000000000000000000000000000000000000005f5260045260245ffd5b60448887604051917fc4433ed500000000000000000000000000000000000000000000000000000000835260048301526024820152fd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b5f604085015113808091611fd6575b15611f6b5750506040517f259982e5000000000000000000000000000000000000000000000000000000006020820152611f62916112aa82611f368887898c33602487016136cb565b037fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08101845283612e2e565b505b8580611587565b159081611fc8575b50611f7f575b50611f64565b6040517f21d0ee70000000000000000000000000000000000000000000000000000000006020820152611fc1916112aa82611f368887898c33602487016136cb565b5085611f79565b610200915016151587611f73565b5061080082161515611eed565b346103305760607ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126103305761201a612d3f565b73ffffffffffffffffffffffffffffffffffffffff612037612d62565b91165f52600560205273ffffffffffffffffffffffffffffffffffffffff60405f2091165f5260205260405f206044355f52602052602060405f2054604051908152f35b346103305760407ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610330576120b2612d3f565b602435908115158092036103305773ffffffffffffffffffffffffffffffffffffffff90335f52600360205260405f208282165f5260205260405f207fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0081541660ff851617905560405192835216907fceb576d9f15e4e200fdb5096d64d5dfd667e16def20c1eefd14256d8e3faa26760203392a3602060405160018152f35b346103305760c07ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126103305761218a36612e81565b612192612e6f565b906280000062ffffff60408301511614801590612246575b61221e5760a0906121ba8361368e565b205f52600660205260405f20906121d082613576565b81547fffffff000000ffffffffffffffffffffffffffffffffffffffffffffffffffff1660d09190911b7cffffff000000000000000000000000000000000000000000000000000016179055005b7f30d21641000000000000000000000000000000000000000000000000000000005f5260045ffd5b5073ffffffffffffffffffffffffffffffffffffffff6080820151163314156121aa565b346103305760207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126103305760043567ffffffffffffffff8111610330576122b9903690600401612f4d565b7fc090fc4683624cfc3884e9d8de5eca132f2d0ec062aff75d43c0465d5ceeab235c6124cd57612345915f9160017fc090fc4683624cfc3884e9d8de5eca132f2d0ec062aff75d43c0465d5ceeab235d60405193849283927f91dd734600000000000000000000000000000000000000000000000000000000845260206004850152602484019161306c565b038183335af19081156124c2575f9161241a575b507f7d4b3164c6e45b97e7d87b7125a44c5828d005af88f9d751cfd78729c5d99a0b5c6123f25760406020915f7fc090fc4683624cfc3884e9d8de5eca132f2d0ec062aff75d43c0465d5ceeab235d7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f835194859381855280519182918282880152018686015e5f85828601015201168101030190f35b7f5212cba1000000000000000000000000000000000000000000000000000000005f5260045ffd5b90503d805f833e61242b8183612e2e565b8101906020818303126103305780519067ffffffffffffffff8211610330570181601f820112156103305780519067ffffffffffffffff8211611eb1576040519261249e60207fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f8601160185612e2e565b8284526020838301011161033057815f9260208093018386015e8301015281612359565b6040513d5f823e3d90fd5b7f5090d6c6000000000000000000000000000000000000000000000000000000005f5260045ffd5b346103305773ffffffffffffffffffffffffffffffffffffffff61251836612d85565b91929092335f52600560205260405f208282165f5260205260405f20845f526020528260405f205560405192835216907fb3fd5071835887567a0671151121894ddccc2842f1d10bedad13e0d17cace9a760203392a4602060405160018152f35b60207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610330576125ab612d3f565b7fc090fc4683624cfc3884e9d8de5eca132f2d0ec062aff75d43c0465d5ceeab235c156104d7576107a260209161342d565b346103305760407ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610330576024356004356040519160408360208152826020820152019060051b8301916001602060408501935b835481520191019084838210156109cc57506020600191612635565b346103305760207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126103305773ffffffffffffffffffffffffffffffffffffffff61269d612d3f565b6126ab825f54163314613007565b16807fffffffffffffffffffffffff000000000000000000000000000000000000000060025416176002557fb4bd8ef53df690b9943d3318996006dbb82a25f54719d8c8035b516a2a5b8acc5f80a2005b34610330576101007ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126103305761273536612e81565b60c4359060a43560e43567ffffffffffffffff81116103305761275c903690600401612f4d565b9190937fc090fc4683624cfc3884e9d8de5eca132f2d0ec062aff75d43c0465d5ceeab235c156104d75761278e61350f565b60a0842094855f52600660205260405f20946127a986613576565b60808101805173ffffffffffffffffffffffffffffffffffffffff811690813303612943575b50506fffffffffffffffffffffffffffffffff60038801541697881561291b576020986127fb876130aa565b5f03612806876130aa565b5f036fffffffffffffffffffffffffffffffff169060801b179887612907575b866128f2575b5050612839338985613652565b60405190868252858a8301527f29ef05caaff9404b7cb6d1c0e9bbae9eaa7ab2541feba1a9c4248594c08156cb60403393a3519273ffffffffffffffffffffffffffffffffffffffff841693843303612897575b8888604051908152f35b6010166128a5575b8061288d565b6128e6956112aa93611f36926040519788957fe1b4af69000000000000000000000000000000000000000000000000000000008d88015233602488016135bc565b5082808080808061289f565b600201908660801b048154019055898061282c565b60018101828960801b048154019055612826565b7fa74f97ab000000000000000000000000000000000000000000000000000000005f5260045ffd5b602016612951575b806127cf565b6040517fb6a8b0fa000000000000000000000000000000000000000000000000000000006020820152612994916112aa82611f368b898b8d8b33602488016135bc565b508861294b565b346103305760207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261033057600435545f5260205ff35b34610330576129e336612d85565b907fc090fc4683624cfc3884e9d8de5eca132f2d0ec062aff75d43c0465d5ceeab235c156104d7577f1b3d7edb2e9c0b0e7c525b20aaaef0f5940d2ed71663c7d39266ecafac7288596103ed73ffffffffffffffffffffffffffffffffffffffff805f941695612a62612a55876130aa565b8603600f0b3390896130f0565b16938484526004602052604084208685526020526040842061025f828254612ffa565b5f7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610330577fc090fc4683624cfc3884e9d8de5eca132f2d0ec062aff75d43c0465d5ceeab235c156104d75760206107a23361342d565b346103305760607ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261033057612b17612d3f565b612b1f612d62565b604435907fc090fc4683624cfc3884e9d8de5eca132f2d0ec062aff75d43c0465d5ceeab235c156104d757610e2f92612b67612b5a846130aa565b5f03600f0b3390836130f0565b6131f8565b346103305773ffffffffffffffffffffffffffffffffffffffff612b8f36612d85565b91929092335f52600460205260405f20845f5260205260405f20612bb4848254612fed565b90551690815f52600460205260405f20835f5260205260405f20612bd9828254612ffa565b9055604080513380825260208201939093527f1b3d7edb2e9c0b0e7c525b20aaaef0f5940d2ed71663c7d39266ecafac7288599181908101610279565b346103305760207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610330576004357fffffffff00000000000000000000000000000000000000000000000000000000811680910361033057807f01ffc9a70000000000000000000000000000000000000000000000000000000060209214908115612cab575b506040519015158152f35b7f0f632fb30000000000000000000000000000000000000000000000000000000091501482612ca0565b346103305760407ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126103305760209073ffffffffffffffffffffffffffffffffffffffff612d24612d3f565b165f526004825260405f206024355f52825260405f20548152f35b6004359073ffffffffffffffffffffffffffffffffffffffff8216820361033057565b6024359073ffffffffffffffffffffffffffffffffffffffff8216820361033057565b7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc60609101126103305760043573ffffffffffffffffffffffffffffffffffffffff8116810361033057906024359060443590565b6080810190811067ffffffffffffffff821117611eb157604052565b6060810190811067ffffffffffffffff821117611eb157604052565b60a0810190811067ffffffffffffffff821117611eb157604052565b90601f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0910116810190811067ffffffffffffffff821117611eb157604052565b60a4359062ffffff8216820361033057565b7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc60a09101126103305760405190612eb882612e12565b8160043573ffffffffffffffffffffffffffffffffffffffff8116810361033057815260243573ffffffffffffffffffffffffffffffffffffffff8116810361033057602082015260443562ffffff811681036103305760408201526064358060020b81036103305760608201526084359073ffffffffffffffffffffffffffffffffffffffff821682036103305760800152565b9181601f840112156103305782359167ffffffffffffffff8311610330576020838186019501011161033057565b9060207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc8301126103305760043567ffffffffffffffff811161033057826023820112156103305780600401359267ffffffffffffffff84116103305760248460051b83010111610330576024019190565b91908203918211611d9457565b91908201809211611d9457565b1561300e57565b60646040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152600c60248201527f554e415554484f52495a454400000000000000000000000000000000000000006044820152fd5b601f82602094937fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe093818652868601375f8582860101520116010190565b6f800000000000000000000000000000008110156130c857600f0b90565b7f93dafdf1000000000000000000000000000000000000000000000000000000005f5260045ffd5b9190600f0b9182156131f357613126919073ffffffffffffffffffffffffffffffffffffffff8092165f521660205260405f2090565b613132815c9283613b29565b80915d6131a357507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7f7d4b3164c6e45b97e7d87b7125a44c5828d005af88f9d751cfd78729c5d99a0b5c017f7d4b3164c6e45b97e7d87b7125a44c5828d005af88f9d751cfd78729c5d99a0b5d5b565b156131aa57565b60017f7d4b3164c6e45b97e7d87b7125a44c5828d005af88f9d751cfd78729c5d99a0b5c017f7d4b3164c6e45b97e7d87b7125a44c5828d005af88f9d751cfd78729c5d99a0b5d565b505050565b90919073ffffffffffffffffffffffffffffffffffffffff811690816132ea5750505f80808093855af11561322a5750565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f3d011673ffffffffffffffffffffffffffffffffffffffff604051927f90bfb8650000000000000000000000000000000000000000000000000000000084521660048301525f6024830152608060448301528060a00160648301523d60848301523d5f60a484013e7ff4b3b1bc0000000000000000000000000000000000000000000000000000000060c4828401600460a4820152015260e40190fd5b60205f60448194968260409573ffffffffffffffffffffffffffffffffffffffff988751998a947fa9059cbb00000000000000000000000000000000000000000000000000000000865216600485015260248401525af13d15601f3d116001855114161716928281528260208201520152156133635750565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f3d0116604051917f90bfb86500000000000000000000000000000000000000000000000000000000835260048301527fa9059cbb000000000000000000000000000000000000000000000000000000006024830152608060448301528060a00160648301523d60848301523d5f60a484013e7ff27f64e40000000000000000000000000000000000000000000000000000000060c4828401600460a4820152015260e40190fd5b7f27e098c505d44ec3574004bca052aabf76bd35004c182099d8c575fb238593b95c919073ffffffffffffffffffffffffffffffffffffffff8316613482576131a19034935b61347c856130aa565b906130f0565b346134e7576131a1906134be7f1e0745a7db1623981f0b2a5d4232364c00787266eb75ad546f190e6cebe9bd955c6134b986613a92565b612fed565b935f7f27e098c505d44ec3574004bca052aabf76bd35004c182099d8c575fb238593b95d613473565b7fb0ec849e000000000000000000000000000000000000000000000000000000005f5260045ffd5b73ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000000000000004444c5dc75cb358380d2e3de08a9016300361354e57565b7f0d89438e000000000000000000000000000000000000000000000000000000005f5260045ffd5b5473ffffffffffffffffffffffffffffffffffffffff161561359457565b7f486aa307000000000000000000000000000000000000000000000000000000005f5260045ffd5b91926136376101209473ffffffffffffffffffffffffffffffffffffffff61364f999794168552602085019073ffffffffffffffffffffffffffffffffffffffff6080809282815116855282602082015116602086015262ffffff6040820151166040860152606081015160020b6060860152015116910152565b60c083015260e082015281610100820152019161306c565b90565b9073ffffffffffffffffffffffffffffffffffffffff60206131a1949361368185848351168660801d906130f0565b01511690600f0b906130f0565b62ffffff16620f424081116136a05750565b7f14002113000000000000000000000000000000000000000000000000000000005f5260045260245ffd5b9061364f95936137486101609473ffffffffffffffffffffffffffffffffffffffff61377794168552602085019073ffffffffffffffffffffffffffffffffffffffff6080809282815116855282602082015116602086015262ffffff6040820151166040860152606081015160020b6060860152015116910152565b8051600290810b60c08501526020820151900b60e0840152604081015161010084015260600151610120830152565b81610140820152019161306c565b9081600f0b9182036130c857565b926138419061381261364f99979473ffffffffffffffffffffffffffffffffffffffff6101a09895168752602087019073ffffffffffffffffffffffffffffffffffffffff6080809282815116855282602082015116602086015262ffffff6040820151166040860152606081015160020b6060860152015116910152565b8051600290810b60c08701526020820151900b60e0860152604081015161010086015260600151610120850152565b61014083015261016082015281610180820152019161306c565b939590919296945f9673ffffffffffffffffffffffffffffffffffffffff861633146139ac57885f6040870151135f1461393b5761040087166138a2575b50505050505050565b61392e9799985092613927969594926138ef9261391b956040519788967f9f063efc0000000000000000000000000000000000000000000000000000000060208901523360248901613793565b037fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08101835282612e2e565b6002821615159161459f565b80926145bf565b915f808080808080613899565b95949392919061010086166139535750505050505050565b61392e979950869850916138ef916139a09493613927986040519788967f6c2bbe7e0000000000000000000000000000000000000000000000000000000060208901523360248901613793565b6001821615159161459f565b505f96505050505050565b608081161580613a69575b613a3f57604081161580613a5d575b613a3f5761040081161580613a51575b613a3f5761010081161580613a45575b613a3f5773ffffffffffffffffffffffffffffffffffffffff8116613a1f575062ffffff1662800000141590565b613fff161590811591613a30575090565b62800000915062ffffff161490565b50505f90565b506001811615156139f1565b506002811615156139e1565b506004811615156139d1565b506008811615156139c2565b6280000062ffffff821614613a8d5761364f8161368e565b505f90565b73ffffffffffffffffffffffffffffffffffffffff1680613ab257504790565b6020602491604051928380927f70a082310000000000000000000000000000000000000000000000000000000082523060048301525afa9081156124c2575f91613afa575090565b90506020813d602011613b21575b81613b1560209383612e2e565b81010312610330575190565b3d9150613b08565b9190915f8382019384129112908015821691151617611d9457565b6020830151955f9586959194913373ffffffffffffffffffffffffffffffffffffffff851614613d2d5760808416613b7e575b5050505050565b613c66926138ef613c6092613c4c946040519586947f575e24b4000000000000000000000000000000000000000000000000000000006020870152336024870152613c16604487018c73ffffffffffffffffffffffffffffffffffffffff6080809282815116855282602082015116602086015262ffffff6040820151166040860152606081015160020b6060860152015116910152565b8051151560e487015260208101516101048701526040015173ffffffffffffffffffffffffffffffffffffffff16610124860152565b61014061014485015261016484019161306c565b82613f25565b916060835103613d05576040015162ffffff166280000014613cf9575b600816613c94575b80808080613b77565b604001519250608083901d600f0b8015613c8b57613cb5905f861295613b29565b9315613cf1575f84135b613cc9575f613c8b565b7ffa0b71d6000000000000000000000000000000000000000000000000000000005f5260045ffd5b5f8412613cbf565b60608201519350613c83565b7f1e048e1d000000000000000000000000000000000000000000000000000000005f5260045ffd5b505f965086955050505050565b90600f0b90600f0b01907fffffffffffffffffffffffffffffffff8000000000000000000000000000000082126f7fffffffffffffffffffffffffffffff831317611d9457565b9196959394929473ffffffffffffffffffffffffffffffffffffffff83163314613f18578460801d94600f0b938860408516613e40575b50505050505f9481600f0b15801590613e34575b613dd8575b5050509190565b613e0f9395505f60208201511290511515145f14613e17576fffffffffffffffffffffffffffffffff169060801b175b80936145bf565b5f8080613dd1565b906fffffffffffffffffffffffffffffffff169060801b17613e08565b5082600f0b1515613dcc565b613efc613f08946138ef6118ed95613f0e999895613ee1613c16966040519788967fb47b2fb1000000000000000000000000000000000000000000000000000000006020890152336024890152604488019073ffffffffffffffffffffffffffffffffffffffff6080809282815116855282602082015116602086015262ffffff6040820151166040860152606081015160020b6060860152015116910152565b8c61014485015261016061016485015261018484019161306c565b6004821615159161459f565b90613d3a565b5f80808088613db8565b5050505050909150905f90565b9190918251925f8060208301958682865af115613fc3575050604051917fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0603f3d011683016040523d83523d9060208401915f833e6020845110918215613f8f575b5050613d0557565b5190517fffffffff000000000000000000000000000000000000000000000000000000009182169116141590505f80613f87565b5183517fffffffff00000000000000000000000000000000000000000000000000000000811691600481106140d7575b50507fffffffff000000000000000000000000000000000000000000000000000000007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f3d01169173ffffffffffffffffffffffffffffffffffffffff604051947f90bfb865000000000000000000000000000000000000000000000000000000008652166004850152166024830152608060448301528060a00160648301523d60848301523d5f60a484013e7fa9e35b2f0000000000000000000000000000000000000000000000000000000060c4828401600460a4820152015260e40190fd5b7fffffffff000000000000000000000000000000000000000000000000000000009250829060040360031b1b16168280613ff3565b919060020b9060020b9081810761413a5705908160081d5f52602052600160ff60405f2092161b8154189055565b601c906044926040519163d4d8f3e683526020830152604082015201fd5b60020b908160ff1d82810118620d89e8811161449e5763ffffffff9192600182167001fffcb933bd6fad37aa2d162d1a59400102700100000000000000000000000000000000189160028116614482575b60048116614466575b6008811661444a575b6010811661442e575b60208116614412575b604081166143f6575b608081166143da575b61010081166143be575b61020081166143a2575b6104008116614386575b610800811661436a575b611000811661434e575b6120008116614332575b6140008116614316575b61800081166142fa575b6201000081166142de575b6202000081166142c3575b6204000081166142a8575b620800001661428f575b5f12614268575b0160201c90565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff04614261565b6b048a170391f7dc42444e8fa290910260801c9061425a565b6d2216e584f5fa1ea926041bedfe9890920260801c91614250565b916e5d6af8dedb81196699c329225ee6040260801c91614245565b916f09aa508b5b7a84e1c677de54f3e99bc90260801c9161423a565b916f31be135f97d08fd981231505542fcfa60260801c9161422f565b916f70d869a156d2a1b890bb3df62baf32f70260801c91614225565b916fa9f746462d870fdf8a65dc1f90e061e50260801c9161421b565b916fd097f3bdfd2022b8845ad8f792aa58250260801c91614211565b916fe7159475a2c29b7443b29c7fa6e889d90260801c91614207565b916ff3392b0822b70005940c7a398e4b70f30260801c916141fd565b916ff987a7253ac413176f2b074cf7815e540260801c916141f3565b916ffcbe86c7900a88aedcffc83b479aa3a40260801c916141e9565b916ffe5dee046a99a2a811c461f1969c30530260801c916141df565b916fff2ea16466c96a3843ec78b326b528610260801c916141d6565b916fff973b41fa98c081472e6896dfb254c00260801c916141cd565b916fffcb9843d60f6159c9db58835c9266440260801c916141c4565b916fffe5caca7e10e4e61c3624eaa0941cd00260801c916141bb565b916ffff2e50f5f656932ef12357cf3c7fdcc0260801c916141b2565b916ffff97272373d413259a46990580e213a0260801c916141a9565b827f8b86327a000000000000000000000000000000000000000000000000000000005f5260045260245ffd5b905f83600f0b125f146144ff576144f5925f036fffffffffffffffffffffffffffffffff1691615a3d565b5f81126130c85790565b61451b926fffffffffffffffffffffffffffffffff16916159e2565b5f81126130c8575f0390565b905f83600f0b125f14614552576144f5925f036fffffffffffffffffffffffffffffffff1691615b34565b61451b926fffffffffffffffffffffffffffffffff1691615a7d565b906fffffffffffffffffffffffffffffffff90600f0b911601908160801c61459257565b6393dafdf15f526004601cfd5b906145a991613f25565b9015613a8d576040815103613d05576040015190565b6145e2906145d48360801d8260801d03613785565b92600f0b90600f0b03613785565b6fffffffffffffffffffffffffffffffff169060801b1790565b73fffd8963efd1fc6a506488495d951d516396168273ffffffffffffffffffffffffffffffffffffffff7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffefffd895d830116116148e05777ffffffffffffffffffffffffffffffffffffffff000000008160201b168060ff61467983615bdb565b1691608083106148d457507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8182011c5b800280607f1c8160ff1c1c800280607f1c8160ff1c1c800280607f1c8160ff1c1c800280607f1c8160ff1c1c800280607f1c8160ff1c1c800280607f1c8160ff1c1c80029081607f1c8260ff1c1c80029283607f1c8460ff1c1c80029485607f1c8660ff1c1c80029687607f1c8860ff1c1c80029889607f1c8a60ff1c1c80029a8b607f1c8c60ff1c1c80029c8d80607f1c9060ff1c1c800260cd1c6604000000000000169d60cc1c6608000000000000169c60cb1c6610000000000000169b60ca1c6620000000000000169a60c91c6640000000000000169960c81c6680000000000000169860c71c670100000000000000169760c61c670200000000000000169660c51c670400000000000000169560c41c670800000000000000169460c31c671000000000000000169360c21c672000000000000000169260c11c674000000000000000169160c01c67800000000000000016907fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff800160401b1717171717171717171717171717693627a301d71055774c85027ffffffffffffffffffffffffffffffffffd709b7e5480fba5a50fed5e62ffc556810160801d60020b906fdb2df09e81959a81455e260799a0632f0160801d60020b918282145f146148915750905090565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff6148c584614158565b16116148cf575090565b905090565b905081607f031b6146a9565b73ffffffffffffffffffffffffffffffffffffffff907f61487524000000000000000000000000000000000000000000000000000000005f521660045260245ffd5b811561492c570490565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b6040519290915f61496985612df6565b5f855260208501925f845260408601955f875280968654956040860151159586155f146156f557610fff8860b81c16945b8151925f948a73ffffffffffffffffffffffffffffffffffffffff16918288528b60a01c60020b90526fffffffffffffffffffffffffffffffff60038d0154169052608083015162400000811615155f146156e65762bfffff166149fd8161368e565b61ffff88166156cb575b8096620f424062ffffff8316101561569a575b8451156156845750508861562457606083019073ffffffffffffffffffffffffffffffffffffffff825116818110156155ed5750505173ffffffffffffffffffffffffffffffffffffffff166401000276a38111156155c257505b604051986101008a018a811067ffffffffffffffff821117611eb1576040525f8a525f60208b01525f60408b01525f60608b01525f60808b01525f60a08b01525f60c08b015288155f146155b45760018b0154949390945b60e08b01525b8015801561557a575b6154205788868d8c8e73ffffffffffffffffffffffffffffffffffffffff8351168252602083015160020b602089015160020b90815f8183071291050386155f14615275576fffffffffffffffffffffffffffffffff937ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff2761860409460019484600560ff60609716938260020b60081d890b5f5201602052875f207fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8460ff031c9054169283151593845f146152635790614bb760ff92615bdb565b90031660020b900360020b0260020b5b905b15158684015260020b8060208401521315615238575b620d89e8602082015160020b121561522a575b73ffffffffffffffffffffffffffffffffffffffff614c17602083015160020b614158565b16918291015273ffffffffffffffffffffffffffffffffffffffff8551169673ffffffffffffffffffffffffffffffffffffffff60608c0151169283911516818310189118021892015116928d73ffffffffffffffffffffffffffffffffffffffff8316821015915f87125f1461507f5762ffffff8516620f424003614c9f81895f03615785565b94841561506e57614cb1888483615a7d565b955b868110614fb257509660a093929173ffffffffffffffffffffffffffffffffffffffff98978891620f424062ffffff8316145f14614f9e575050865b955b15614f905791614d0092615a3d565b925b60c0820152015260808d0152168c525f8351135f14614f605760a08a0151905f82126130c8570392614d3d60808b015160c08c015190612ffa565b5f81126130c8578103908113600116611d9457935b61ffff8716614f18575b6fffffffffffffffffffffffffffffffff60408d01511680614efe575b5073ffffffffffffffffffffffffffffffffffffffff8c511673ffffffffffffffffffffffffffffffffffffffff60608c01511681145f14614ec2575060408a0151614e10575b88614e03577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff60208b015160020b0160020b5b60020b60208d01525b9392614ad3565b60208a015160020b614df3565b88614e96576fffffffffffffffffffffffffffffffff614e7d8d8d8d600460e08201519260206002820154935b015160020b60020b5f520160205260405f2091600183019081549003905560028201908154900390555460801d908c15614e88575b60400151831661456e565b1660408d0152614dc0565b5f91909103600f0b90614e72565b6fffffffffffffffffffffffffffffffff614e7d8d8d8d6004600183015492602060e084015193614e3d565b73ffffffffffffffffffffffffffffffffffffffff8b51168103614ee7575b50614dfc565b614ef0906145fc565b60020b60208d01525f614ee1565b60c08b015160801b0460e08b01510160e08b01525f614d79565b9662ffffff861661ffff881603614f435760c08a0151905b8160c08c01510360c08c01520196614d5c565b620f424060808b015161ffff89169060c08d015101020490614f30565b60808a015160c08b015101905f82126130c857019260a08a01515f81126130c857614f8a91613b29565b93614d52565b614f9992615b34565b614d00565b62ffffff614fad921689615c68565b614cef565b9650505092505082918415811517615061578e60a09173ffffffffffffffffffffffffffffffffffffffff96845f14614ffc57614ff0878284615d07565b80978a015f0395614cf1565b87871161503a576150356150306150286fffffffffffffffffffffffffffffffff84168a60601b614922565b8a8516612ffa565b615d9b565b614ff0565b61503561503061505c6fffffffffffffffffffffffffffffffff84168a61588a565b615028565b634f2461b85f526004601cfd5b6150798882856159e2565b95614cb3565b9193509190831561521957615095858284615a3d565b915b8287106150f7579073ffffffffffffffffffffffffffffffffffffffff9560a09280965b156150e857916150ca92615a7d565b925b6150e362ffffff8d16620f42408190039086615c68565b614d02565b6150f1926159e2565b926150cc565b50915050838315821517615061578d83156151ef575073ffffffffffffffffffffffffffffffffffffffff851161519c578460601b6fffffffffffffffffffffffffffffffff851680820615159104015b73ffffffffffffffffffffffffffffffffffffffff8316928184111561518f578f939573ffffffffffffffffffffffffffffffffffffffff60a093819803165b80966150bb565b634323a5555f526004601cfd5b6fffffffffffffffffffffffffffffffff84166151c7816c0100000000000000000000000088615943565b90801561492c576c010000000000000000000000008709156151485760010180615148575f80fd5b9180856152148873ffffffffffffffffffffffffffffffffffffffff9860a095615c91565b615188565b615224858383615b34565b91615097565b620d89e86020820152614bf2565b7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff276186020820152614bdf565b5060020b900360020b0260020b614bc7565b60019194939650600592955001938460020b60081d60010b5f520160205260405f207fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff600160ff86161b0119905416908d8b831592831597885f146153c15750505050610330578f9160018f8f96907ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff276186060928f989560409660ff896fffffffffffffffffffffffffffffffff9a5f03166101e07f804040554300526644320000502061067405302602000010750620017611707760fc7fb6db6db6ddddddddd34d34d349249249210842108c6318c639ce739cffffffff840260f81c161b60f71c167e1f0d1e100c1d070f090b19131c1706010e11080a1a141802121b1503160405601f85851693831c63d76453e004161a17031660020b9060020b0160020b0260020b5b90614bc9565b90956fffffffffffffffffffffffffffffffff955060409450600193987ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff27618918960ff6060969b811681031660020b9060020b0160020b0260020b6153bb565b949891955099969298919598602088015160a01b76ffffff0000000000000000000000000000000000000000167fffffffffffffffffff000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff8a51169216171782556fffffffffffffffffffffffffffffffff6003830154166fffffffffffffffffffffffffffffffff604089015116809103615535575b5082156155265760e060029101519101555b825190155f82121461551057506154ee6154f69293613785565b925103613785565b6fffffffffffffffffffffffffffffffff169060801b1793565b6154f69250906155209103613785565b91613785565b60e060019101519101556154d4565b6fffffffffffffffffffffffffffffffff167fffffffffffffffffffffffffffffffff000000000000000000000000000000006003840154161760038301555f6154c2565b5073ffffffffffffffffffffffffffffffffffffffff8c511673ffffffffffffffffffffffffffffffffffffffff60608501511614614adc565b60028b015494939094614acd565b7f9e4d7cc7000000000000000000000000000000000000000000000000000000005f5260045260245ffd5b60449250604051917f7c9c6e8f00000000000000000000000000000000000000000000000000000000835260048301526024820152fd5b606083019073ffffffffffffffffffffffffffffffffffffffff825116818111156155ed5750505173ffffffffffffffffffffffffffffffffffffffff1673fffd8963efd1fc6a506488495d951d5263988d268110156155c25750614a75565b9a509a50509950505050505050505f925f929190565b5f85511315614a1a577f96206246000000000000000000000000000000000000000000000000000000005f5260045ffd5b62ffffff610fff89169116620f424081830204910103614a07565b508960d01c62ffffff166149fd565b610fff8860c41c169461499a565b90808202917fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff828209918380841093039280840393847001000000000000000000000000000000001115610330571461577c57700100000000000000000000000000000000910990828211900360801b910360801c1790565b50505060801c90565b818102907fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff83820990828083109203918083039283620f424011156103305714615804577fde8f6cefed634549b62c77574f722e1ac57e23f24d8fd5cb790fb65668c2613993620f4240910990828211900360fa1b910360061c170290565b5050620f424091500490565b90808202917fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff828209918380841093039280840393846c0100000000000000000000000011156103305714615881576c01000000000000000000000000910990828211900360a01b910360601c1790565b50505060601c90565b908160601b907fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6c01000000000000000000000000840992828085109403938085039485841115610330571461593c576c0100000000000000000000000082910981805f03168092046002816003021880820260020302808202600203028082026002030280820260020302808202600203028091026002030293600183805f03040190848311900302920304170290565b5091500490565b91818302917fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8185099383808610950394808603958685111561033057146159da579082910981805f03168092046002816003021880820260020302808202600203028082026002030280820260020302808202600203028091026002030293600183805f03040190848311900302920304170290565b505091500490565b6fffffffffffffffffffffffffffffffff6c010000000000000000000000009173ffffffffffffffffffffffffffffffffffffffff80600195169116038060ff1d90810118931692615a348185615810565b93091515160190565b6fffffffffffffffffffffffffffffffff9073ffffffffffffffffffffffffffffffffffffffff8061364f9594169116038060ff1d908101189116615810565b9073ffffffffffffffffffffffffffffffffffffffff811673ffffffffffffffffffffffffffffffffffffffff831611615b2e575b73ffffffffffffffffffffffffffffffffffffffff8216928315615b22577bffffffffffffffffffffffffffffffff00000000000000000000000073ffffffffffffffffffffffffffffffffffffffff615b16948185169403169160601b16615c68565b90808206151591040190565b62bfc9215f526004601cfd5b90615ab2565b73ffffffffffffffffffffffffffffffffffffffff821673ffffffffffffffffffffffffffffffffffffffff821611615bd5575b73ffffffffffffffffffffffffffffffffffffffff8116918215615b225761364f937bffffffffffffffffffffffffffffffff00000000000000000000000073ffffffffffffffffffffffffffffffffffffffff615bd0948185169403169160601b16615943565b614922565b90615b68565b8015610330577f07060605060205000602030205040001060502050303040105050304000000006f8421084210842108cc6318c6db6d54be826fffffffffffffffffffffffffffffffff1060071b83811c67ffffffffffffffff1060061b1783811c63ffffffff1060051b1783811c61ffff1060041b1783811c60ff1060031b1792831c1c601f161a1790565b929190615c76828286615943565b93821561492c5709615c8457565b9060010190811561033057565b91908115615d02577bffffffffffffffffffffffffffffffff00000000000000000000000073ffffffffffffffffffffffffffffffffffffffff9160601b169216918282029183838311918404141615615cf55761364f9261503092820391615c68565b63f5c787f15f526004601cfd5b505090565b90918015615d955773ffffffffffffffffffffffffffffffffffffffff7bffffffffffffffffffffffffffffffff000000000000000000000000819460601b16921680820281615d578483614922565b14615d7d575b5090615d6c615d719284614922565b612ffa565b80820615159104011690565b8301838110615d5d579150615d9192615c68565b1690565b50905090565b9073ffffffffffffffffffffffffffffffffffffffff82169182036130c85756fea164736f6c634300081a000a"));

        engine.state.init_account(
            pool_manager,
            AccountInfo {
                balance: *MAX_BALANCE,
                nonce: 0,
                code_hash: B256::from(keccak256(pool_manager_bytecode.clone().bytes())),
                code: Some(pool_manager_bytecode),
            },
            None,
            false,
        );

        Ok(GenericVMHookHandler {
            contract: TychoSimulationContract::new_contract(address, bytecode, engine)?,
            address,
            pool_manager,
        })
    }

    pub fn unlock_pool_manager(&self) {
        // see here how to set transient storage on the revm:
        // https://github.com/propeller-heads/tycho-v4-hooks-prototype/blob/main/revm-tstore/src/main.rs#L10
        // the slot is here https://github.com/Uniswap/v4-core/blob/main/src/libraries/Lock.sol#L8C5-L8C117
        // TODO: do we really need this?? I'm thinking no. we only need the msg.sender to be the
        // pool manager
        todo!()
    }
}

sol! {
    struct BeforeSwapReturn {
        bytes4 selector;
        int256 amountDelta;
        uint24 fee;
    }
}

impl<D: EngineDatabaseInterface + Clone + Debug + 'static> HookHandler for GenericVMHookHandler<D>
where
    <D as DatabaseRef>::Error: Debug,
    <D as EngineDatabaseInterface>::Error: Debug,
{
    fn address(&self) -> Address {
        self.address
    }

    fn before_swap(
        &self,
        params: BeforeSwapParameters,
        block: u64,
    ) -> Result<WithGasEstimate<BeforeSwapDelta>, HookError> {
        let args = (
            params.sender,
            (
                params.context.currency_0,
                params.context.currency_1,
                Uint::<24, 1>::from(params.context.fees.lp_fee),
                Signed::<24, 1>::try_from(params.context.tick).unwrap(),
                self.address,
            ),
            (
                params.swap_params.zero_for_one,
                params.swap_params.amount_specified,
                U160::from(params.swap_params.sqrt_price_limit),
            ),
            AlloyBytes::from(params.hook_data.to_vec()),
        );
        let selector = "beforeSwap(address,(address,address,uint24,int24,address),(bool,int256,uint160),bytes)";

        let res = self.contract.call(
            selector,
            args,
            block,
            None,
            None,
            Some(self.pool_manager),
            U256::from(0u64),
        )?;

        println!("Before swap call result: {:?}", res);
        let decoded: BeforeSwapReturn =
            BeforeSwapReturn::abi_decode(&res.return_value).map_err(|e| {
                SimulationError::FatalError(format!(
                    "Failed to decode before swap return value: {e:?}"
                ))
            })?;
        Ok(WithGasEstimate {
            gas_estimate: res.simulation_result.gas_used,
            result: decoded.amountDelta,
        })
    }

    fn after_swap(&self, params: AfterSwapParameters) -> Result<WithGasEstimate<i128>, HookError> {
        self.unlock_pool_manager();
        todo!()
        // self.contract.call(..)
    }

    fn fee(&self, context: &UniswapV4State, params: SwapParams) -> Result<f64, HookError> {
        todo!()
    }

    fn spot_price(&self, base: &Token, quote: &Token) -> Result<f64, HookError> {
        todo!()
    }

    fn get_amount_ranges(
        &self,
        token_in: Address,
        token_out: Address,
    ) -> Result<AmountRanges, HookError> {
        todo!()
    }

    fn delta_transition(
        &mut self,
        delta: ProtocolStateDelta,
        tokens: &HashMap<Bytes, Token>,
        balances: &Balances,
    ) -> Result<(), TransitionError<String>> {
        todo!()
    }

    fn clone_box(&self) -> Box<dyn HookHandler> {
        Box::new((*self).clone())
    }

    fn as_any(&self) -> &dyn Any {
        self
    }

    fn is_equal(&self, other: &dyn HookHandler) -> bool {
        other
            .as_any()
            .downcast_ref::<Self>()
            .map_or(false, |o| self == o)
    }
}

struct GenericVMHookHandlerCreator<D>
where
    D: EngineDatabaseInterface + Clone + Debug,
    <D as DatabaseRef>::Error: Debug,
    <D as EngineDatabaseInterface>::Error: Debug,
{
    engine: SimulationEngine<D>,
}

impl<D> HookHandlerCreator for GenericVMHookHandlerCreator<D>
where
    D: EngineDatabaseInterface + Clone + Debug,
    <D as DatabaseRef>::Error: Debug,
    <D as EngineDatabaseInterface>::Error: Debug,
{
    fn instantiate_hook_handler(
        &self,
        params: HookCreationParams,
    ) -> Result<Box<dyn HookHandler>, InvalidSnapshotError> {
        let db = SHARED_TYCHO_DB.clone();
        let hook_address = Address::from_slice(
            &*params
                .attributes
                .get("hook_address")
                .ok_or_else(|| InvalidSnapshotError::MissingAttribute("hook_address".to_string()))?
                .clone(),
        );
        let engine = create_engine(db, false)?;
        Ok(Box::new(GenericVMHookHandler::new(hook_address, Bytecode::new(), engine)?))
    }
}

#[cfg(test)]
mod tests {
    use std::str::FromStr;

    use alloy::primitives::{B256, I256};

    use super::*;
    use crate::evm::{
        engine_db::{
            simulation_db::{BlockHeader, SimulationDB},
            utils::{get_client, get_runtime},
        },
        protocol::uniswap_v4::{hook_handler::StateContext, state::UniswapV4Fees},
    };

    #[test]
    fn test_hook_simulation() {
        let block = BlockHeader {
            number: 22578103,
            hash: B256::from_str(
                "0x035c0e674c3bf3384a74b766908ab41c1968e989360aa26bea1dd64b1626f5f0",
            )
            .unwrap(),
            timestamp: 1748397011,
        };
        let db = SimulationDB::new(get_client(None), get_runtime(), Some(block));
        let engine = create_engine(db, true).expect("Failed to create simulation engine");

        let hook_address = Address::from_str("0x0010d0d5db05933fa0d9f7038d365e1541a41888")
            .expect("Invalid hook address");
        let bytecode = Bytecode::new_raw(AlloyBytes::from_str("0x6080604052600436101561001a575b3615610018575f80fd5b005b5f803560e01c80630b9a71521461385c5780630be21ab51461374e5780631299e3bb146136a9578063136793551461365257806315dcc2e0146136365780631626ba7e146135ce5780631a362e401461355f57806323c0571b146134df57806325692962146134965780632b02feaf146133e85780632dbfa735146133bc5780632e6ee7c3146133785780633465dc0c1461334e5780634ea83fe51461306f578063531f4dd214612fe957806354d1f13d14612fa35780635578f4e914612e0a578063575e24b4146129d25780635790ae1d146128a55780635a4eaae21461286e5780636fb70c76146128425780636fe7e6eb146126cb578063715018a6146126855780637ba36684146125885780637bc385a814612503578063859049d3146123765780638da5cb5b1461234b57806391dd73461461173457806396bf8dd6146116f557806399c02eef14611650578063a15dd0b514611218578063ababb83c146111c9578063aefa4619146111a2578063b55a1b7e14611092578063b8372e0b14610fd5578063c6b4968814610fa6578063c92907f014610dad578063c982bcca14610d5f578063cceb676514610d36578063cd39aa8e14610c21578063dc4c90d314610bdd578063e3b077a114610af4578063efb40e5714610a68578063f04e283e146109e8578063f2fde38b1461097b578063f96f97f21461079f578063fb20e17e1461071f578063fe0316a2146102755763fee81cf414610240575061000e565b3461027257602060031936011261027257610259613a46565b9063389a75e1600c5252602080600c2054604051908152f35b80fd5b5034610272576101006003193601126102725761029061590c565b6001600160a01b03807f0000000000000000000000000000000000f0d1c07ca806ab9154199e2e627ea61633036106f55760a06102cc36613efb565b2090601f1982845260209260088452813601356040862054036106cb578452600883525f6040852055600983525f6040852055600a83525f6040852055600d83526040842080547effffffff0000000000000000000000000000000000000000000000000000004260d81b16907fff0000000000000000ffffffffffffffffffffffffffffffffffffffffffffff7affffffff00000000000000000000000000000000000000000000004260b81b169116171790557f07bd55ea91cddb9c2c27beeba6deadeb8f557caeb242f82d756cf1d33154a78c5c826103ac6140e9565b166106b2576040517f70a0823100000000000000000000000000000000000000000000000000000000815230600482015290857f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc285168684602481845afa93841561062357829461067f575b5083813b1561067b5782916024839260405194859384927f2e1a7d4d00000000000000000000000000000000000000000000000000000000845260048401525af1801561062357610663575b505061046f916142df565b6104776140e9565b936004359084821680920361065f576104e9610523948897946104c189966104b56104dd978b6104a56140e9565b16146040519485938985016141e1565b038381018352826139c1565b6040519485916001868401526040808401526060830190613b0b565b039081018452836139c1565b60405193849283927f48c8949100000000000000000000000000000000000000000000000000000000845260048401526024830190613b0b565b038183867f000000000000000000000000000000000004444c5dc75cb358380d2e3de08a90165af1801561065457610632575b507359f17b5b56a3e156becfdcf1f12298fc88e165b790813b1561062e57829060e4604051809481937f434e2739000000000000000000000000000000000000000000000000000000008352600660048401527f000000000000000000000000000000dceb71f3107909b1b748424349bfde54931660248301526105dc6044830161417b565b5af480156106235761060f575b507f99d6ee9363d15a40a5ab48bebc5e3e7dd2c4e190c950f55fe724fad94b380d7e5d80f35b61061890613975565b61027257805f6105e9565b6040513d84823e3d90fd5b5050fd5b61064d903d8085833e61064581836139c1565b810190614264565b505f610556565b6040513d85823e3d90fd5b5f80fd5b61066c90613975565b61067757855f610464565b8580fd5b8280fd5b87809295508193503d83116106ab575b61069981836139c1565b8101031261065f57869051925f610418565b503d61068f565b61046f906106c66106c16140e9565b615966565b6142df565b60046040517f5dac7a1b000000000000000000000000000000000000000000000000000000008152fd5b60046040517f1424d63b000000000000000000000000000000000000000000000000000000008152fd5b50346102725760206003193601126102725760406080916004358152600d60205220606060405191610750836139a5565b546001600160a01b038116928381528160a01c60020b9081602082015263ffffffff808460b81c169384604084015260d81c169384910152604051938452602084015260408301526060820152f35b503461027257600319360160c081126109775760a0136102725767ffffffffffffffff9060a435828111610977576107db903690600401613a72565b9092604051917f88ec5b47000000000000000000000000000000000000000000000000000000008352838360e481019683600698600660048501526108226024850161417b565b60e060c4850152526101048201909383905b8082106109495750508192935003817359f17b5b56a3e156becfdcf1f12298fc88e165b75af49182156106545783926108aa575b5050604051916020808401906020855283518092526020604086019401925b8281106108945785850386f35b8351870b85529381019392810192600101610887565b9091503d8084833e6108bc81836139c1565b810191602091828185031261094557805191821161094557019180601f840112156109415782516108ec816142c7565b936108fa60405195866139c1565b818552838086019260051b820101928311610677578301905b82821061092557505050505f80610868565b815180880b810361093d578152908301908301610913565b8680fd5b8380fd5b8480fd5b9250925083359063ffffffff821680920361065f576001918152602080910194019201928692938692610834565b5080fd5b50602060031936011261027257610990613a46565b610998615853565b8060601b156109db576001600160a01b0316638b78c6d8198181547f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08580a35580f35b637448fbae82526004601cfd5b506020600319360112610272576109fd613a46565b610a05615853565b63389a75e1600c528082526020600c2080544211610a5b5790826001600160a01b03925516638b78c6d8198181547f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08580a35580f35b636f5e881883526004601cfd5b503461027257600319360160c081126109775760a01361027257610ab9610ab3608092610a9361443a565b5060a0610a9f36613efb565b2081526006602052604060a435912061449e565b5061445e565b610af260405180926060809163ffffffff8151168452602081015160020b6020850152604081015160060b604085015201511515910152565bf35b50346102725760a060031936011261027257604060e0918151610b16816139a5565b81815281602082015281838201526060610b2e61443a565b91015260a0610b3c36613efb565b208152600760205220610af260405191610b55836139a5565b805463ffffffff90818116855281610b8760016020880195838560201c1687528360408a019560401c1685520161445e565b936060870194855281604051975116875251166020860152511660408401525160608301906060809163ffffffff8151168452602081015160020b6020850152604081015160060b604085015201511515910152565b503461027257806003193601126102725760206040516001600160a01b037f000000000000000000000000000000000004444c5dc75cb358380d2e3de08a90168152f35b50346102725760406003193601126102725763ffffffff6004358181169081810361065f576024359283169283810361065f57610c5c615853565b620f4240808411908115610d2c575b50610d02577fffffffff0000000000000000ffffffffffffffffffffffffffffffffffffffff77ffffffff00000000000000000000000000000000000000007bffffffff000000000000000000000000000000000000000000000000600e549360c01b169360a01b1691161717600e557fc387745583c7cf0995c8df449e448850ec7404926444e12abb8538b82c38ea9f8380a380f35b60046040517f58e6eb95000000000000000000000000000000000000000000000000000000008152fd5b905084115f610c6b565b5034610272576020600319360112610272576020610d55600435614512565b6040519015158152f35b503461027257604060031936011261027257610d79613a46565b6040610d83613a5c565b926001600160a01b03809316815260056020522091165f52602052602060405f2054604051908152f35b503461027257610dbc36613ad1565b91610dc56144af565b91610dcf82614512565b15610f7c57610ddd826145a6565b50508185526001602052610df360408620613b30565b6001600160a01b0380808351169516948503610f525760608201916001600160801b039081610e258186511687613ba1565b16610f28576080610e4991019382610e40878288511661434e565b91511690613ca6565b8165ffffffffffff7f0000000000000000000000000000000000000000000000000000000000001c2016911610610efe5783610ee5610eae7fd6cbb6e489a2ca95eea500cfdffb93e083287ee5a015abb7ed0fe2fdd770fe809684602097511661434e565b878b5260018652600160408c2001906001600160801b036fffffffffffffffffffffffffffffffff1983549260801b169116179055565b1695610ef287828761575b565b6040519687521694a480f35b60046040517f9aa6880d000000000000000000000000000000000000000000000000000000008152fd5b60046040517fa2d53a3c000000000000000000000000000000000000000000000000000000008152fd5b60046040517fb601a689000000000000000000000000000000000000000000000000000000008152fd5b60046040517f47d88c52000000000000000000000000000000000000000000000000000000008152fd5b5034610272576040600319360112610272576020610fcd610fc5613a5c565b600435614392565b604051908152f35b503461027257602060031936011261027257611013604061108e92600435610ffb613c2e565b50611005816145a6565b505081528060205220613b30565b60405191829182919091608060a08201936001600160a01b03815116835265ffffffffffff60208201511660208401527fffffffffffff00000000000000000000000000000000000000000000000000006040820151166040840152816060820151916001600160801b038093166060860152015116910152565b0390f35b5034610272576040600319360112610272576004356110af61395f565b906110b86144af565b916110c282614512565b15610f7c576110d0826145a6565b505081845260016020526110e660408520613b30565b906001600160a01b039384835116948116948503610f52576001600160801b0392836111188160608401511685613ba1565b16610f2857838361118f6111586020967f018ca21103a82dec7bc9c112d22fe77a99b58608eac0ed93262243e30fe1da1598608061119897015116613be6565b888b5260018752600160408c2001906001600160801b036fffffffffffffffffffffffffffffffff1983549260801b169116179055565b16809286614eea565b604051908152a380f35b503461027257806003193601126102725760206001600160a01b03600e5416604051908152f35b50346102725760406003193601126102725760406020916111e8613a46565b6001600160a01b03602435916111fd836145a6565b50501682526004845282822090825283522054604051908152f35b50346102725760a060031936011261027257611232613a5c565b7fffffffffffff0000000000000000000000000000000000000000000000000000604435166044350361065f576001600160801b03606435166064350361065f576001600160801b03608435166084350361065f5761128f6144af565b9061129b600435614512565b15610f7c576112ab6004356145a6565b50506001600160a01b0381161580156115df575b801561158f575b8015611570575b801561155b575b8015611534575b61150a5760043583526001602052604083206001600160a01b03600182015491541684526004602052604084206004358552602052611322604085209160801c8254614385565b905561148865ffffffffffff6113587f00000000000000000000000000000000000000000000000000000000014bd762436142df565b169261147360405161136981613989565b6001600160a01b03851681526001600160801b038781600160208501948a8652604081017fffffffffffff00000000000000000000000000000000000000000000000000006044351681526060820196846064351688527fffffffffffff000000000000000000000000000000000000000000000000000079ffffffffffff00000000000000000000000000000000000000006001600160a01b036040608087019989608435168b5260043581528860205220955116925160a01b169251169117178155019351166fffffffffffffffffffffffffffffffff1984541617835551166001600160801b036fffffffffffffffffffffffffffffffff1983549260801b169116179055565b6001600160801b036084351690600435614eea565b6001600160a01b03604051917fffffffffffff00000000000000000000000000000000000000000000000000006044351683526001600160801b036064351660208401526001600160801b0360843516604084015216907f892cf75ad2a5896151df4a595c62378620b908182714c75fc026987990dfa7c9606060043592a480f35b60046040517fcf8172ed000000000000000000000000000000000000000000000000000000008152fd5b506001600160801b03611548600435615594565b166001600160801b0360643516106112db565b5061156a604435600435614ffb565b156112d4565b506001600160801b03611587606435608435613ba1565b1615156112cd565b506001600160801b036115cc65ffffffffffff7f0000000000000000000000000000000000000000000000000000000000001c2016606435614367565b166001600160801b0360843516106112c6565b50600435835260016020526001600160801b036001604085200154167810c50f78edb1e1d81828a2cb16cd80b4a2de5ba4dce252a7ef811161164357670f43fc2c04ee0000670de0b6b3a76400009102046001600160801b036064351611156112bf565b63bac65e5b5f526004601cfd5b50346102725760206003193601126102725761166a613c2e565b5061108e6116796004356150b5565b5060405191829182919091608060a08201936001600160a01b03815116835265ffffffffffff60208201511660208401527fffffffffffff00000000000000000000000000000000000000000000000000006040820151166040840152816060820151916001600160801b038093166060860152015116910152565b503461027257602060031936011261027257611013604061108e9260043561171b613c2e565b50611725816145a6565b50508152600160205220613b30565b5034610272576020806003193601126109775767ffffffffffffffff9160043583811161097757611769903690600401613aa3565b6001600160a01b0391827f000000000000000000000000000000000004444c5dc75cb358380d2e3de08a90169182330361232157810160408282031261094557813590600392600383101561093d578781013590898211611ad8576117cf929101613a00565b9181611adc5750508085806117e9935183010191016159f0565b908592957f000000000000000000000000000000dceb71f3107909b1b748424349bfde54931691823b15611ad857604051907ff89ee44e0000000000000000000000000000000000000000000000000000000082526118896004830184608090816001600160a01b039182815116855282602082015116602086015262ffffff6040820151166040860152606081015160020b6060860152015116910152565b151560a48201528760c48201528660e482015287816101048183875af18015611acd57908891611ab9575b5050813b1561093d5761193860a488928360405195869485937f3fac65060000000000000000000000000000000000000000000000000000000085526004850190608090816001600160a01b039182815116855282602082015116602086015262ffffff6040820151166040860152606081015160020b6060860152015116910152565b5af18015611aae57908691611a9a575b5050823b15610945576040517ff5298aca000000000000000000000000000000000000000000000000000000008152306004820152908216602482015260448101849052848160648183875af18015611a8f57908591611a7b575b5050813b15610941576040517f0b0d9c090000000000000000000000000000000000000000000000000000000081526001600160a01b03919091166004820152306024820152604481019290925282908290606490829084905af1801561062357908291611a67575b50505b6040519282840190811184821017611a3a57604052825261108e604051928284938452830190613b0b565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b611a7090613975565b61027257805f611a0c565b611a8490613975565b61094157835f6119a3565b6040513d87823e3d90fd5b611aa390613975565b61094557845f611948565b6040513d88823e3d90fd5b611ac290613975565b61093d57865f6118b4565b6040513d8a823e3d90fd5b8780fd5b600191808303611e5b57505050808580611afb935183010191016159f0565b9491928491943b1561093d5782604051917fa58411940000000000000000000000000000000000000000000000000000000083521690816004820152878160248183875af18015611acd57908891611e47575b5050878115948515611ddf575b60049515611dd8575b604051958680927f11da60b4000000000000000000000000000000000000000000000000000000008252865af1938415611dcd578794611d9e575b50813b1561093d576040517f156e29f60000000000000000000000000000000000000000000000000000000081523060048201526024810191909152604481018490529086908290606490829084905af18015611aae57908691611d8a575b50507f000000000000000000000000000000dceb71f3107909b1b748424349bfde54931690813b15610945576040517f9445c4a8000000000000000000000000000000000000000000000000000000008152611c9b6004820185608090816001600160a01b039182815116855282602082015116602086015262ffffff6040820151166040860152606081015160020b6060860152015116910152565b858160a48183875af18015611aae57908691611d76575b5050813b1561094557849283611d39936101049360405197889687957ff89ee44e0000000000000000000000000000000000000000000000000000000087526004870190608090816001600160a01b039182815116855282602082015116602086015262ffffff6040820151166040860152606081015160020b6060860152015116910152565b151560a485015260c48401528160e48401525af1801561062357908291611d62575b5050611a0f565b611d6b90613975565b61027257805f611d5b565b611d7f90613975565b61094557845f611cb2565b611d9390613975565b61094557845f611bfe565b9093508781813d8311611dc6575b611db681836139c1565b8101031261065f5751925f611b9f565b503d611dac565b6040513d89823e3d90fd5b5087611b64565b83601452806034526fa9059cbb000000000000000000000000895281896044601082875af1958660018b51141615611e1e575b60348a90529550611b5b565b9150919293943d843b15171015611e3a57849392918991611e12565b6390b8ec1888526004601cfd5b611e5090613975565b61093d57865f611b4e565b939493600214611e70575b5050505050611a0f565b8251830192878181860195031261093d578781015190898211611ad857019083603f8301121561093d578782015193611ea8856142c7565b92611eb660405194856139c1565b858452898401906040829760051b8201019283116121c05760408b919896959801915b838310612301575050505082600e5416958288905b611f64575b50505060405193878501908886525180915260408501939287905b89838310611f4d5750505050505090807f343ec735634cde6c74e128c9997c907fee57a10d2d60ddd6c6edd5b3deae4363920390a25f80808080611e66565b855182168752958601959094019390830190611f0e565b86939496518110156122f85786611f7b82866142ec565b516040517efdd58e000000000000000000000000000000000000000000000000000000008152306004820152911660248201819052908b81604481875afa9081156122125790858d8d8a9796959481946122c0575b508490525260408c2054611fe3916142df565b9081611ff8575b505082019091939694611eee565b9091928094503b156121ef576040517ff5298aca00000000000000000000000000000000000000000000000000000000815230600482015260248101829052604481018390528b8160648183895af180156121f357908c916122ac575b50508061221d57833b156121ef576040517f0b0d9c090000000000000000000000000000000000000000000000000000000081526001600160a01b03919091166004820152306024820152604481018290528a8160648183885af1801561221257908b916121fe575b5050877f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc216803b156121ef576040517fd0e30db00000000000000000000000000000000000000000000000000000000081528b8160048186865af180156121f3578d92918d916121d6575b506040517fa9059cbb0000000000000000000000000000000000000000000000000000000081526001600160a01b038d1660048201526024810194909452839160449183915af180156121cb57908693929161218b575b5082905b905f611fea565b909192508a81813d83116121c4575b6121a481836139c1565b810103126121c0578592916121b9849261432d565b5090612180565b8980fd5b503d61219a565b6040513d8c823e3d90fd5b6121e291929350613975565b6121ef578b908b5f612129565b8a80fd5b6040513d8e823e3d90fd5b61220790613975565b6121c057895f6120be565b6040513d8d823e3d90fd5b833b156121ef576040517f0b0d9c090000000000000000000000000000000000000000000000000000000081526001600160a01b039182166004820152908a1660248201526044810191909152898160648183875af180156121cb57869392918b9161228d575b50508290612184565b61229a9192939450613975565b6122a857908491895f612284565b8880fd5b6122b590613975565b6121ef578a5f612055565b9750508092508691503d83116122f1575b6122db81836139c1565b8101031261065f579251869390858d8d84611fd0565b503d6122d1565b95939295611ef3565b8190612310849a97989a61433a565b8152019101908a9097959497611ed9565b60046040517fae18210a000000000000000000000000000000000000000000000000000000008152fd5b50346102725780600319360112610272576020638b78c6d819546001600160a01b0360405191168152f35b5034610272576020806003193601126109775760043567ffffffffffffffff811161067b576123aa83913690600401613a72565b6123b593919361590c565b6001600160a01b0393604051918060408401858086015252606083019190855b8181106124d7575050509161242982612465969361241d950390612401601f19928381018352826139c1565b6040519586916002868401526040808401526060830190613b0b565b039081018552846139c1565b836040518096819582947f48c8949100000000000000000000000000000000000000000000000000000000845260048401526024830190613b0b565b03927f000000000000000000000000000000000004444c5dc75cb358380d2e3de08a90165af18015610623576124bd575b50807f99d6ee9363d15a40a5ab48bebc5e3e7dd2c4e190c950f55fe724fad94b380d7e5d80f35b6124d0903d8084833e61064581836139c1565b505f612496565b918094959650929092359087821680920361065f579081528795949390850192908501916001016123d5565b5034610272576020600319360112610272576040906004358152600b602052206040516060810181811067ffffffffffffffff821117611a3a5760609260409182525460ff81161515928381526effffffffffffffffffffffffffffff808360081c169283602084015260801c16928391015260405192835260208301526040820152f35b503461027257602090816003193601126102725760043567ffffffffffffffff811161097757826125bf6044923690600401613aa3565b928391601f19601f60405196879586947f7ba366840000000000000000000000000000000000000000000000000000000086528860048701528160248701528686013788858286010152011681010301817359f17b5b56a3e156becfdcf1f12298fc88e165b75af4918215612679578092612641575b50506040519015158152f35b9091508282813d8311612672575b61265981836139c1565b81010312610272575061266b9061432d565b5f80612635565b503d61264f565b604051903d90823e3d90fd5b508060031936011261027257612699615853565b80638b78c6d8198181547f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08280a35580f35b503461027257610100600319360112610272576126e6613a46565b60a07fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdc3601126109775760c435906001600160a01b0380831680930361065f5760e4358060020b80910361065f57817f000000000000000000000000000000000004444c5dc75cb358380d2e3de08a901633036123215784927359f17b5b56a3e156becfdcf1f12298fc88e165b7803b1561094557836101449360405197889687957f8e04931e000000000000000000000000000000000000000000000000000000008752600660048801521660248601526127c460448601614115565b60e48501526101048401527f000000000000000000000000000000dceb71f3107909b1b748424349bfde5493166101248301525af480156106235761282e575b60206040517f6fe7e6eb000000000000000000000000000000000000000000000000000000008152f35b6128388291613975565b6102725780612804565b50346102725760206003193601126102725760406020916004358152600a835220544211604051908152f35b5034610272578060031936011261027257600e546040805163ffffffff60a084901c8116825260c09390931c909216602083015290f35b5034610272576128b436613ad1565b916128bd6144af565b916128c782614512565b15610f7c576128d5826145a6565b5050818552846020526128ea60408620613b30565b6001600160a01b0380808351169516948503610f525760608201916001600160801b03908161291c8186511687613ba1565b16610f2857608061293791019382610e40878288511661434e565b8165ffffffffffff7f0000000000000000000000000000000000000000000000000000000000001c2016911610610efe5783610ee561299c7f804678e3e29c23a5bf87029444349f6b833eab92ed696f51ed1d9412e738d0279684602097511661434e565b878b528a8652600160408c2001906001600160801b036fffffffffffffffffffffffffffffffff1983549260801b169116179055565b503461027257610140600319360112610272576129ed613a46565b9060a07fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdc3601126102725760607fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff3c3601126102725767ffffffffffffffff916101243583811161067b57612a65903690600401613aa3565b50506001600160a01b037f000000000000000000000000000000000004444c5dc75cb358380d2e3de08a9016330361232157612a9f61590c565b600e54926001600160a01b03600f5416906040519461010086019186831090831117611a3a5763ffffffff91604052818160a01c16865260c01c1660208501526001600160a01b037f000000000000000000000000000000dceb71f3107909b1b748424349bfde54931660408501526001600160a01b037f000000000000000000000000000000000004444c5dc75cb358380d2e3de08a901660608501526001600160a01b037f0000000000000000000000000000000000f0d1c07ca806ab9154199e2e627ea616608085015260a08401526001600160a01b037f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc21660c08401526001600160a01b037f000000000000000000000000000000000022d473030f116ddee9f6b43ac78ba31660e08401526001600160a01b0360e0604051947f09ed8ad50000000000000000000000000000000000000000000000000000000086526006600487015263ffffffff815116602487015263ffffffff60208201511660448701528260408201511660648701528260608201511660848701528260808201511660a48701528260a08201511660c48701528260c08201511660e48701520151918161010493168386015216610124840152612c816101448401614115565b60c43580151580910361065f576101e484015260e435610204840152356001600160a01b03811680910361065f5761022483015260a082610244817359f17b5b56a3e156becfdcf1f12298fc88e165b75af490811561267957809281829083928495612da0575b50606095612d4a575b505050807f99d6ee9363d15a40a5ab48bebc5e3e7dd2c4e190c950f55fe724fad94b380d7e5d604051917f575e24b400000000000000000000000000000000000000000000000000000000835260208301526040820152f35b6001600160a01b0316835260056020526001600160a01b0360408420911690815f5260205260405f20612d7e838254614385565b905582526003602052612d9660408320918254614385565b90555f8080612cf1565b9450505050915060a0813d60a011612e02575b81612dc060a093836139c1565b8101031261097757606091612dd48261432d565b612de06020840161433a565b92612ded6040820161433a565b60808683015192015192949091929495612ce8565b3d9150612db3565b5034610272576020806003193601126109775760043567ffffffffffffffff811161067b57612e3d903690600401613a72565b9092612e48826142c7565b93612e5660405195866139c1565b828552612e62836142c7565b92601f198587019401368537826001600160a01b0392837f000000000000000000000000000000000004444c5dc75cb358380d2e3de08a9016915b838110612ee757505050505060405193838594850191818652518092526040850193925b828110612ed057505050500390f35b835185528695509381019392810192600101612ec1565b80600599979896991b8201359085821680920361065f576040517efdd58e000000000000000000000000000000000000000000000000000000008152306004820152602481018390528781604481885afa908115612212578b91612f75575b50612f5f906001938c526003895260408c2054906142df565b612f69828a6142ec565b52019794969597612e9d565b90508781813d8311612f9c575b612f8c81836139c1565b8101031261065f57516001612f46565b503d612f82565b50806003193601126102725763389a75e1600c52338152806020600c2055337ffa7b8eab7da67f412cc9575ed43464468f9bfbae89d1675917346ca6d8fe3c928280a280f35b5034610272576020600319360112610272576004356001600160a01b0381168091036109775760207f21014fa276f518db71a4b74f0526c61ed7661bf69a707c64a30d5b0040b7113c9161303b615853565b807fffffffffffffffffffffffff0000000000000000000000000000000000000000600f541617600f55604051908152a180f35b503461065f5761010060031936011261065f5761308a61590c565b6001600160a01b03807f0000000000000000000000000000000000f0d1c07ca806ab9154199e2e627ea61633036106f55760a06130c636613efb565b2090601f19915f526020600881528236013560405f2054036106cb57816130eb6140e9565b1661333e576040517f70a082310000000000000000000000000000000000000000000000000000000081523060048201528181602481867f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2165afa9081156132c2575f91613311575b505b7f07bd55ea91cddb9c2c27beeba6deadeb8f557caeb242f82d756cf1d33154a78c5d6131806140ff565b9260c435936024359284841680940361065f576104e95f93876131b06104dd956104b56131cb998b6104a56140ff565b60405194859187868401526040808401526060830190613b0b565b038183867f000000000000000000000000000000000004444c5dc75cb358380d2e3de08a90165af180156132c2576132f7575b508161320b6106c16140ff565b106132cd57806132196140ff565b1615613247575b82807f99d6ee9363d15a40a5ab48bebc5e3e7dd2c4e190c950f55fe724fad94b380d7e5d80f35b7f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc216803b1561065f575f906004604051809481937fd0e30db00000000000000000000000000000000000000000000000000000000083525af180156132c2576132b1575b80613220565b6132bb9150613975565b5f806132ab565b6040513d5f823e3d90fd5b60046040517f4539e67f000000000000000000000000000000000000000000000000000000008152fd5b61330a903d805f833e61064581836139c1565b505f6131fe565b90508181813d8311613337575b61332881836139c1565b8101031261065f57515f613154565b503d61331e565b6133496106c16140e9565b613156565b3461065f57602060031936011261065f576004355f52600c602052602060405f2054604051908152f35b3461065f57604060031936011261065f576001600160a01b03613399613a46565b165f52600460205260405f206024355f52602052602060405f2054604051908152f35b3461065f57604060031936011261065f576020610fcd6133da613a46565b6133e2613a5c565b90613f74565b3461065f57600319360160c0811261065f5760a01361065f5763ffffffff60a435818116810361065f5760a061341d36613efb565b205f52600760205261344360405f2092835460401c169160066020528260405f2061586f565b82547fffffffffffffffffffffffffffffffffffffffff00000000ffffffffffffffff16604082811b6bffffffff00000000000000001691909117909355825163ffffffff928316815291166020820152f35b5f60031936011261065f5763389a75e1600c52335f526202a30042016020600c2055337fdbf36a107da19e49527a7176a1babf963b4b0ff8cde35ee35d6cd8f1f9ac7e1d5f80a2005b3461065f57602060031936011261065f577f1ad2c8d0e069471d98a667bcf612463b372082f8870dc6d167a3793a133931ab60206001600160a01b03613523613a46565b61352b615853565b16807fffffffffffffffffffffffff0000000000000000000000000000000000000000600e541617600e55604051908152a1005b3461065f5760a060031936011261065f5761357861395f565b604435906001600160801b0390818316830361065f57606435801515810361065f57608435906001600160a01b038216820361065f576040946135bd93600435613cbe565b835191831682529091166020820152f35b3461065f57604060031936011261065f5760243567ffffffffffffffff811161065f5761360c6136046020923690600401613a00565b600435613c58565b7fffffffff0000000000000000000000000000000000000000000000000000000060405191168152f35b3461065f57602060031936011261065f576100186004356145a6565b3461065f57604060031936011261065f576001600160a01b037f000000000000000000000000000000dceb71f3107909b1b748424349bfde54931633036106f5576004355f52600c60205260243560405f20555f80f35b3461065f57602060031936011261065f576136c2613c2e565b5061108e6136d16004356150b5565b905060405191829182919091608060a08201936001600160a01b03815116835265ffffffffffff60208201511660208401527fffffffffffff00000000000000000000000000000000000000000000000000006040820151166040840152816060820151916001600160801b038093166060860152015116910152565b3461065f57606060031936011261065f576024356004357fffffffffffff0000000000000000000000000000000000000000000000000000821680830361065f57604435928315159182850361065f576137a66144af565b946137b085614512565b15610f7c576137be856145a6565b50501561384a57835f525f60205260405f20925b8354926001600160a01b038097169684168703610f52576137f39086614ffb565b1561150a577fd89758def3a89808b83911284af1db38111ea1b042a45f0d39d526f67fab7a37938279ffffffffffffffffffffffffffffffffffffffffffffffffffff6040951617905582519182526020820152a3005b835f52600160205260405f20926137d2565b3461065f57604060031936011261065f5760043561387861395f565b906138816144af565b9161388b82614512565b15610f7c57613899826145a6565b5050815f525f6020526138ae60405f20613b30565b906001600160a01b039384835116948116948503610f52576001600160801b0392836138e08160608401511685613ba1565b16610f2857838361118f6139206020967f5fedbb7fbc8b2dd98c779ccc8c3d8e18dc48cc2eb1cb0215af9c1f77741d869a98608061395697015116613be6565b885f525f8752600160405f2001906001600160801b036fffffffffffffffffffffffffffffffff1983549260801b169116179055565b604051908152a3005b602435906001600160801b038216820361065f57565b67ffffffffffffffff8111611a3a57604052565b60a0810190811067ffffffffffffffff821117611a3a57604052565b6080810190811067ffffffffffffffff821117611a3a57604052565b90601f601f19910116810190811067ffffffffffffffff821117611a3a57604052565b67ffffffffffffffff8111611a3a57601f01601f191660200190565b81601f8201121561065f57803590613a17826139e4565b92613a2560405194856139c1565b8284526020838301011161065f57815f926020809301838601378301015290565b600435906001600160a01b038216820361065f57565b602435906001600160a01b038216820361065f57565b9181601f8401121561065f5782359167ffffffffffffffff831161065f576020808501948460051b01011161065f57565b9181601f8401121561065f5782359167ffffffffffffffff831161065f576020838186019501011161065f57565b600319606091011261065f57600435906024356001600160801b038116810361065f57906044356001600160a01b038116810361065f5790565b90601f19601f602080948051918291828752018686015e5f8582860101520116010190565b90604051613b3d81613989565b6080600182947fffffffffffff000000000000000000000000000000000000000000000000000081546001600160a01b038116865265ffffffffffff8160a01c16602087015216604085015201546001600160801b0381166060840152811c910152565b906001600160801b03809116918215613bb957160690565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b9190916001600160801b0380809416911601918211613c0157565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b60405190613c3b82613989565b5f6080838281528260208201528260408201528260608201520152565b9190915f9260208180518101031261065f57602001515f52600960205260405f205414613c8157565b7f1626ba7e000000000000000000000000000000000000000000000000000000009150565b906001600160801b03809116918215613bb957160490565b9491949392935f915f94613cd06144af565b96613cda84614512565b15610f7c576001600160801b0390818416958615613eea57899a613d02879b98999a9b6145a6565b50508215613ed957865f525f60205260405f205b613d1f81613b30565b6001600160a01b039788808351169b169a8b03610f5257613d469087606084015116613be6565b86613d518286613ba1565b1615801590613ec4575b61150a57613d698185613ca6565b8765ffffffffffff7f0000000000000000000000000000000000000000000000000000000000001c2016911610610efe576001600160801b0390871616608084811b6fffffffffffffffffffffffffffffffff191691909117600193909301929092550180518286169390861680851115613e4257505091613e1c8560a0979593817ff9f1ab7a2f5f90eeba49c837a758919739dc7e5ea102551b4251fb11552d57b29a98965116900316809e8a614eea565b604051998a5260208a015215156040890152808b166060890152891660808801521694a4565b91509c50808310613e7d575b50509160a093917ff9f1ab7a2f5f90eeba49c837a758919739dc7e5ea102551b4251fb11552d57b29593613e1c565b84929b509360a09593917ff9f1ab7a2f5f90eeba49c837a758919739dc7e5ea102551b4251fb11552d57b2979503169a613eb88c858a61575b565b91939581939550613e4e565b5086613ecf8b615594565b1687821610613d5b565b865f52600160205260405f20613d16565b50505050505050925050505f905f90565b60031960a091011261065f5760405190613f1482613989565b6001600160a01b0382600435828116810361065f578152602435828116810361065f57602082015260443562ffffff8116810361065f5760408201526064358060020b810361065f576060820152608435918216820361065f5760800152565b91906001600160a01b039283613f886144af565b1690815f5260206005815260409086825f20931692835f528152815f20549687156140de57845f5260058252825f20845f5282525f8381205560038252825f208881540390558251927f095bcdb60000000000000000000000000000000000000000000000000000000084528284806140208c898c600485016040919493926001600160a01b03606083019616825260208201520152565b03815f867f000000000000000000000000000000000004444c5dc75cb358380d2e3de08a90165af180156140d457614080575b7fee447878094bcc87bd81b55e4831b5e9e3d095866fce10f4f7e4caa64ea7a558935051958887521694a4565b8284813d83116140cd575b61409581836139c1565b8101031261065f576140c77fee447878094bcc87bd81b55e4831b5e9e3d095866fce10f4f7e4caa64ea7a5589461432d565b50614053565b503d61408b565b50513d5f823e3d90fd5b505f96505050505050565b60e4356001600160a01b038116810361065f5790565b60a4356001600160a01b038116810361065f5790565b602435906001600160a01b039182811680910361065f57815260443582811680910361065f57602082015260643562ffffff811680910361065f5760408201526084358060020b80910361065f57606082015260a43591821680920361065f5760800152565b600435906001600160a01b039182811680910361065f57815260243582811680910361065f57602082015260443562ffffff811680910361065f5760408201526064358060020b80910361065f57606082015260843591821680920361065f5760800152565b9193926101008301946001600160a01b038093168452602084015260043582811680910361065f57604084015260243582811680910361065f57606084015260443562ffffff811680910361065f5760808401526064358060020b80910361065f5760a084015260843591821680920361065f5760e09160c08401521515910152565b60208183031261065f5780519067ffffffffffffffff821161065f570181601f8201121561065f57805190614298826139e4565b926142a660405194856139c1565b8284526020838301011161065f57815f9260208093018386015e8301015290565b67ffffffffffffffff8111611a3a5760051b60200190565b91908203918211613c0157565b80518210156143005760209160051b010190565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5190811515820361065f57565b51906001600160a01b038216820361065f57565b6001600160801b039182169082160391908211613c0157565b9190916001600160801b0380809416911602918216918203613c0157565b91908201809211613c0157565b919061439c6144af565b926143a681614512565b15610f7c576143b4816145a6565b50506001600160a01b0380941690815f52600460205260405f20815f5260205260405f20549485156144315760207fb50cab7f3cadbfcd988880bdb754510d79ca993ead3b8c09b58559769f6d920691845f526004825260405f20845f5282525f604081205561442588878661575b565b604051958887521694a4565b505f9450505050565b60405190614447826139a5565b5f6060838281528260208201528260408201520152565b9060405161446b816139a5565b606060ff82945463ffffffff811684528060201c60020b60208501528060381c60060b604085015260701c161515910152565b62ffffff8210156143005701905f90565b335f526e2fd5aeb385d324b580fca7c83823a08033146144ff575b506dd9ecebf3c23529de49815dac1c4c8033146144e8575b505f5190565b5f80806020935afa156144fb575f6144e2565b3838fd5b5f80806020935afa156144fb575f6144ca565b604051907f129f38ea00000000000000000000000000000000000000000000000000000000825260048201525f816024816001600160a01b037f000000000000000000000000000000dceb71f3107909b1b748424349bfde5493165afa9081156132c25760ff916020915f9161458c575b50015116151590565b6145a091503d805f833e61064581836139c1565b5f614583565b65ffffffffffff6145d77f00000000000000000000000000000000000000000000000000000000014bd762436142df565b1691815f5260026020528265ffffffffffff60405f20541614614e8e57915f60205261460560405f20613b30565b92825f52600160205261461a60405f20613b30565b935f80935f915b87849861462c613c2e565b50614635613c2e565b505f975f935f925f985f956001600160a01b03815116155f14614add5750506001600160a01b038d5116614a09575b9b99801580614a01575b6146e5579181614699936001600160a01b03959391156146dd575b509581156146d5575b5096614385565b9516806146ac575b505094929194614621565b5f52600460205260405f20885f526020526146cc60405f20918254614385565b90555f806146a1565b90505f614692565b90505f614689565b50935093955050509691949695939561493a575b61486f575b50815f52600260205260405f20907fffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000082541617905581614770575b50507fffffffffffff000000000000000000000000000000000000000000000000000060406001600160a01b038451169301511690565b6001600160a01b0390604051907fa2a566970000000000000000000000000000000000000000000000000000000082526004820152602081602481857f000000000000000000000000000000dceb71f3107909b1b748424349bfde5493165afa9081156132c2575f91614840575b501690813b1561065f575f916024839260405194859384927f42966c6800000000000000000000000000000000000000000000000000000000845260048401525af180156132c257614831575b80614739565b61483a90613975565b5f61482b565b614862915060203d602011614868575b61485a81836139c1565b810190614ecb565b5f6147de565b503d614850565b61493490835f526001602052600160405f206001600160a01b0383511679ffffffffffff0000000000000000000000000000000000000000602085015160a01b16907fffffffffffff00000000000000000000000000000000000000000000000000006040860151169117178155019060806001600160801b0391826060820151166fffffffffffffffffffffffffffffffff198554161784550151166001600160801b036fffffffffffffffffffffffffffffffff1983549260801b169116179055565b5f6146fe565b835f525f6020526149fc600160405f206001600160a01b038a511679ffffffffffff000000000000000000000000000000000000000060208c015160a01b16907fffffffffffff000000000000000000000000000000000000000000000000000060408d0151169117178155016001600160801b038060608b0151166fffffffffffffffffffffffffffffffff1983541617825560808a0151166001600160801b036fffffffffffffffffffffffffffffffff1983549260801b169116179055565b6146f9565b50851561466e565b99909b91926001600160801b03614a3765ffffffffffff806020870151168a03168260608701511690614367565b60808501519116906001600160801b03168110614a905750505060806001600160801b039101511690604051614a6c81613989565b5f81525f60208201525f60408201525f60608201525f60808201529a600199614664565b809d929b9194939d614aa3575b50614664565b935099506001600160801b03614ac88d826080614abf88615ab5565b9201511661434e565b1660808d01528560208d01526001995f614a9d565b81516001600160a01b0316614b6f57505065ffffffffffff7f0000000000000000000000000000000000000000000000000000000000001c2081602084015116011680881015614b2d5750614664565b929550809c506020919a509b0152604051614b4781613989565b5f81525f60208201525f60408201525f60608201525f6080820152926001986001945f614a9d565b94856060839f9e9498979d9c9b9a999396959d01516001600160801b031695606001516001600160801b03169e8f7810c50f78edb1e1d81828a2cb16cd80b4a2de5ba4dce252a7ef10611643578f670f43fc2c04ee0000670de0b6b3a764000091020487115f14614e6d576001600160801b03614c4765ffffffffffff8c8180806020880151168093031691817f0000000000000000000000000000000000000000000000000000000000001c208160208b015116011603168181109082180218165b65ffffffffffff836060860151169116614367565b60808301519116906001600160801b03168110614d5057505050505050909192939495969798999a60806001600160801b039101511691670de0b6b3a7640000670f43fc2c04ee0000604051614c9c81613989565b5f81525f60208201525f60408201525f60608201525f60808201529d0204105f14614d4a5765ffffffffffff807f0000000000000000000000000000000000000000000000000000000000001c20816020880151160116868110908718028618165b65ffffffffffff60208601918180845116917f0000000000000000000000000000000000000000000000000000000000001c209003168181119082180218169052600198600194614664565b84614cfe565b9e9f909193999a9b9c9d9596929798949e80614e34575b5065ffffffffffff7f0000000000000000000000000000000000000000000000000000000000001c2081602087015116011692838c10159182614e15575b5050614db4575b505050614664565b965099509c5050985092506001600160801b0360806001600160a01b0384511693015116919560208b0152604051614deb81613989565b5f81525f60208201525f60408201525f60608201525f6080820152926001986001945f8080614dac565b670de0b6b3a7640000919250670f43fc2c04ee00000204105f80614da5565b97509d506001600160801b03614e58614e4c89615ab5565b8260808501511661434e565b16608082015289602082015260019d5f614d67565b6001600160801b03614c4765ffffffffffff806020850151168d0316614c32565b9150505f60205260405f2054907fffffffffffff00000000000000000000000000000000000000000000000000006001600160a01b038316921690565b9081602091031261065f57516001600160a01b038116810361065f5790565b906001600160a01b03604051927fa2a5669700000000000000000000000000000000000000000000000000000000845260048401526020928381602481857f000000000000000000000000000000dceb71f3107909b1b748424349bfde5493165afa9283156132c2575f8386956064948391614fde575b5060405198899687957f23b872dd0000000000000000000000000000000000000000000000000000000087521660048601523060248601526044850152165af180156132c257614faf575050565b81813d8311614fd7575b614fc381836139c1565b8101031261065f57614fd49061432d565b50565b503d614fb9565b614ff59150873d89116148685761485a81836139c1565b5f614f61565b604051907f129f38ea00000000000000000000000000000000000000000000000000000000825260048201525f816024816001600160a01b037f000000000000000000000000000000dceb71f3107909b1b748424349bfde5493165afa80156132c2576020915f9161509b575b5062ffffff918291015160881c1690818360e81c1115928361508b575b50505090565b60d01c16111590505f8080615085565b6150af91503d805f833e61064581836139c1565b5f615068565b906150be613c2e565b506150c7613c2e565b5065ffffffffffff6150f97f00000000000000000000000000000000000000000000000000000000014bd762436142df565b1690825f525f60205261510e60405f20613b30565b925f52600160205261512260405f20613b30565b838161512c613c2e565b50615135613c2e565b505f925f926001600160a01b039182815116155f1461524057505086511661517b575b9491159081615172575b5061516d5792615122565b929150565b9050155f615162565b919094602081019065ffffffffffff80835116870316926001600160801b0392836151ae60609682888701511690614367565b1660809485850191818351168110155f146151f7575050505050505f9081604051936151d985613989565b81855281602086015281604086015284015282015293600191615158565b8a959b97508091929394989650615213575b5050505050615158565b61522f9192939495975061522690615ab5565b8284511661434e565b16905252600191845f808080615209565b9091825116155f146152cc5750506020810165ffffffffffff7f0000000000000000000000000000000000000000000000000000000000001c2081835116011680871015615290575b5050615158565b93509550905093526040516152a481613989565b5f81525f60208201525f60408201525f60608201525f60808201526001906001905f80615289565b926001600160801b036060859994969399015116936001600160801b0360608a015116987810c50f78edb1e1d81828a2cb16cd80b4a2de5ba4dce252a7ef8a1161164357670de0b6b3a7640000670f43fc2c04ee00008b0204861115615573576001600160801b0361539865ffffffffffff8b8180806020880151168093031691817f0000000000000000000000000000000000000000000000000000000000001c208160208b0151160116031681811090821802181665ffffffffffff836060860151169116614367565b60808301519116906001600160801b0316811061548757505050505050670de0b6b3a7640000670f43fc2c04ee00006040516153d381613989565b5f81525f60208201525f60408201525f60608201525f6080820152960204105f146154815765ffffffffffff807f0000000000000000000000000000000000000000000000000000000000001c20816020850151160116848110908518028418165b65ffffffffffff60208301918180845116917f0000000000000000000000000000000000000000000000000000000000001c209003168181119082180218169052600190600190615158565b82615435565b90818a929b9598969b979497615546575b505050602081019265ffffffffffff7f0000000000000000000000000000000000000000000000000000000000001c2081865116011692838a10159182615527575b50506154e9575b505050615158565b9350935095505093526040516154fe81613989565b5f81525f60208201525f60408201525f60608201525f60808201526001906001905f80806154e1565b670de0b6b3a7640000919250670f43fc2c04ee00000204105f806154da565b602092939850615560614e4c6001600160801b0392615ab5565b1660808201520152600194875f80615498565b6001600160801b0361539865ffffffffffff806020850151168c0316614c32565b6001600160a01b0390817f000000000000000000000000000000dceb71f3107909b1b748424349bfde5493169160409283517f129f38ea0000000000000000000000000000000000000000000000000000000081528360048201525f81602481855afa9081156157375765ffffffffffff9186915f91615741575b50015160b01c169284519182917fa2a56697000000000000000000000000000000000000000000000000000000008352600483015281602460209485935afa908115615737579082915f9161571a575b5060048651809581937f18160ddd000000000000000000000000000000000000000000000000000000008352165afa93841561571157505f936156e1575b505080820291818304036156d7575b506001600160801b0390670de0b6b3a76400008082061515910401818111156156d3575090565b1690565b611643575f6156ac565b9080929350813d831161570a575b6156f981836139c1565b8101031261065f5751905f8061569d565b503d6156ef565b513d5f823e3d90fd5b6157319150823d84116148685761485a81836139c1565b5f61565f565b85513d5f823e3d90fd5b61575591503d805f833e61064581836139c1565b5f61560f565b6001600160a01b0392604051917fa2a5669700000000000000000000000000000000000000000000000000000000835260048301526020928383602481887f000000000000000000000000000000dceb71f3107909b1b748424349bfde5493165afa9081156132c25761581f9585945f93615832575b505f906040518098819682957fa9059cbb00000000000000000000000000000000000000000000000000000000845260048401602090939291936001600160a01b0360408201951681520152565b0393165af180156132c257614faf575050565b5f91935061584c90863d88116148685761485a81836139c1565b92906157d1565b638b78c6d81954330361586257565b6382b429005f526004601cfd5b9063ffffffff918282169182156158e257838516928311156158da575b828482161061589c575050505090565b6001816158aa86938561449e565b50827fffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000825416179055011661588c565b935050505090565b60046040517fab7760cc000000000000000000000000000000000000000000000000000000008152fd5b7f99d6ee9363d15a40a5ab48bebc5e3e7dd2c4e190c950f55fe724fad94b380d7e6001815c1461593c576001905d565b60046040517fbb6b8f9a000000000000000000000000000000000000000000000000000000008152fd5b6001600160a01b03168061597957504790565b6020602491604051928380927f70a082310000000000000000000000000000000000000000000000000000000082523060048301525afa9081156132c2575f916159c1575090565b90506020813d6020116159e8575b816159dc602093836139c1565b8101031261065f575190565b3d91506159cf565b80910390610100821261065f57615a068161433a565b9260a07fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc0602084015194011261065f57604051615a4281613989565b615a4e6040840161433a565b8152615a5c6060840161433a565b6020820152608083015162ffffff8116810361065f57604082015260a08301518060020b810361065f57606082015260c08301516001600160a01b038116810361065f57608082015291615ab29060e00161432d565b90565b700100000000000000000000000000000000811015615ada576001600160801b031690565b6335278d125f526004601cfdfea2646970667358221220a6098121ea03772f76b8f4c42c83043858f363f31990332e18d8d75ea6a5bd0b64736f6c63430008190033").unwrap());
        let hook_handler = GenericVMHookHandler::new(hook_address, bytecode, engine)
            .expect("Failed to create GenericVMHookHandler");

        // simulating this tx: 0x6eef1c491d72edf73efd007b152b18d5f7814c5f3bd1c7d9be465fb9b4920f17
        let params = BeforeSwapParameters {
            context: StateContext {
                currency_0: Address::from_str("0x0000000000000000000000000000000000000000")
                    .unwrap(),
                currency_1: Address::from_str("0x000000c396558ffbab5ea628f39658bdf61345b3")
                    .unwrap(), // BUNNI
                fees: UniswapV4Fees { zero_for_one: 0, one_for_zero: 0, lp_fee: 1 },
                tick: 60,
            },
            sender: Address::from_str("0x66a9893cc07d91d95644aedd05d03f95e1dba8af").unwrap(),
            swap_params: SwapParams {
                zero_for_one: true,
                amount_specified: I256::try_from(-200000000000000000i128).unwrap(),
                sqrt_price_limit: U256::from(4295128740u64),
            },
            hook_data: Default::default(),
        };

        let result = hook_handler.before_swap(params, block.number);

        println!("Result: {:?}", result.clone().unwrap());
        assert!(result.is_ok(), "Hook execution failed");
    }
}
